<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>IsivoltPro v14 ‚Äî Panel Central</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800;900&family=Orbitron:wght@500;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<style>
/* ============================================================
   TOKENS & RESET
   ============================================================ */
:root {
  --bg:       #050912;
  --surface:  #080f20;
  --card:     #0b1428;
  --card2:    #0e1830;
  --line:     #1c2a4a;
  --line2:    #243359;
  --text:     #e8f0ff;
  --muted:    #8aa4d0;
  --dim:      #4d638a;

  --green:    #1de87a;
  --yellow:   #ffd24d;
  --red:      #ff4d63;
  --blue:     #3a9fff;
  --purple:   #b94fff;
  --orange:   #ff8c42;

  --glow-g:   rgba(29,232,122,.35);
  --glow-b:   rgba(58,159,255,.35);
  --glow-r:   rgba(255,77,99,.35);

  --r:        16px;
  --r-sm:     10px;
  --shadow:   0 20px 60px rgba(0,0,0,.4);
  --shadow-sm:0 8px 24px rgba(0,0,0,.3);

  --ease:     cubic-bezier(.22,.8,.22,1);
  --dur1:     140ms;
  --dur2:     240ms;
  --dur3:     440ms;

  --nav-h:    62px;
  --top-h:    58px;
}
@media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}

*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  font-family:'Outfit',system-ui,sans-serif;
  font-size:15px;
  line-height:1.45;
  text-rendering:geometricPrecision;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  background:var(--bg);
  color:var(--text);
  min-height:100dvh;
  overflow-x:hidden;
}

/* ============================================================
   BACKGROUND AMBIENCE
   ============================================================ */
#ambience{
  position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 900px 600px at 10% -10%, rgba(58,100,255,.09) 0%, transparent 65%),
    radial-gradient(ellipse 600px 400px at 90% 110%, rgba(185,79,255,.07) 0%, transparent 60%),
    radial-gradient(ellipse 400px 300px at 50% 50%, rgba(29,232,122,.04) 0%, transparent 70%);
}
#gridLines{
  position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.18;
  background-image:
    linear-gradient(rgba(58,159,255,.12) 1px, transparent 1px),
    linear-gradient(90deg, rgba(58,159,255,.12) 1px, transparent 1px);
  background-size:60px 60px;
}

/* ============================================================
   TOPBAR
   ============================================================ */
.topbar{
  position:fixed;top:0;left:0;right:0;height:var(--top-h);z-index:100;
  display:flex;align-items:center;gap:12px;
  padding:0 16px;
  background:rgba(5,9,18,.82);
  border-bottom:1px solid var(--line);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logoBubble{
  width:32px;height:32px;border-radius:10px;
  background:linear-gradient(135deg,#1347ff,#1de87a);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
  box-shadow:0 0 20px rgba(29,232,122,.3);
}
.brandName{font-family:'Orbitron',sans-serif;font-weight:800;font-size:18px;letter-spacing:.4px;line-height:1;white-space:nowrap}
.brandSub{font-size:10px;color:var(--muted);margin-top:2px;white-space:nowrap}

.topSearch{
  flex:1;max-width:320px;
  position:relative;
}
.topSearch input{
  width:100%;
  background:rgba(14,24,48,.7);
  border:1px solid var(--line);
  border-radius:var(--r-sm);
  color:var(--text);
  font:500 13px 'Outfit',sans-serif;
  padding:8px 12px 8px 34px;
  transition:border-color var(--dur1) var(--ease),box-shadow var(--dur1) var(--ease);
}
.topSearch input:focus{
  outline:none;
  border-color:rgba(58,159,255,.6);
  box-shadow:0 0 0 3px rgba(58,159,255,.12);
}
.topSearch::before{
  content:'‚åï';position:absolute;left:10px;top:50%;transform:translateY(-50%);
  color:var(--dim);font-size:16px;pointer-events:none;
}

.topRight{display:flex;align-items:center;gap:8px;margin-left:auto}
.clock{
  font-family:'JetBrains Mono',monospace;
  font-size:18px;font-weight:700;
  background:linear-gradient(90deg,#c9e4ff,#7fc6ff);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  letter-spacing:1px;
}
.datePill{
  background:rgba(14,24,48,.6);
  border:1px solid var(--line);
  border-radius:var(--r-sm);
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  cursor:pointer;
}
.datePill input{
  background:none;border:none;color:var(--muted);
  font:12px 'Outfit',sans-serif;cursor:pointer;
  padding:0;width:90px;
}
.datePill input:focus{outline:none}

.btnIcon{
  width:36px;height:36px;border-radius:var(--r-sm);
  background:rgba(14,24,48,.6);
  border:1px solid var(--line);
  color:var(--text);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
  transition:all var(--dur1) var(--ease);
}
.btnIcon:hover{background:rgba(58,159,255,.15);border-color:rgba(58,159,255,.4)}
.btnIcon.active{background:rgba(29,232,122,.15);border-color:rgba(29,232,122,.4);color:var(--green)}

.userPill{
  display:flex;align-items:center;gap:8px;
  background:rgba(14,24,48,.6);
  border:1px solid var(--line);
  border-radius:var(--r-sm);
  padding:6px 10px;
  cursor:pointer;
  transition:all var(--dur1) var(--ease);
}
.userPill:hover{border-color:var(--line2)}
.avatar{
  width:24px;height:24px;border-radius:50%;
  background:linear-gradient(135deg,#1347ff,#1de87a);
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:900;
}
.userName{font-size:12px;font-weight:700;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ============================================================
   BOTTOM NAV (Mobile-first)
   ============================================================ */
.bottomNav{
  position:fixed;bottom:0;left:0;right:0;
  height:var(--nav-h);z-index:100;
  background:rgba(5,9,18,.88);
  border-top:1px solid var(--line);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  display:flex;align-items:stretch;
  padding-bottom:env(safe-area-inset-bottom);
}
.navItem{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;cursor:pointer;
  color:var(--dim);
  transition:color var(--dur1) var(--ease);
  border:none;background:none;
  font-family:'Outfit',sans-serif;
  position:relative;
}
.navItem.active{color:var(--blue)}
.navItem.active::before{
  content:'';position:absolute;top:0;left:20%;right:20%;
  height:2px;border-radius:0 0 4px 4px;
  background:var(--blue);
  box-shadow:0 0 10px var(--blue);
}
.navIcon{font-size:20px;line-height:1}
.navLabel{font-size:10px;font-weight:700;letter-spacing:.3px}

/* Desktop: hide bottomNav, show sidebar */
@media(min-width:768px){
  .bottomNav{display:none}
  body{padding-bottom:0}
  .layout{margin-left:72px}
  .sidebar{display:flex!important}
}

/* ============================================================
   SIDEBAR (Desktop)
   ============================================================ */
.sidebar{
  display:none;
  position:fixed;left:0;top:var(--top-h);bottom:0;
  width:72px;z-index:90;
  background:rgba(5,9,18,.9);
  border-right:1px solid var(--line);
  flex-direction:column;align-items:center;
  padding:12px 0;gap:4px;
}
.sideItem{
  width:52px;height:52px;border-radius:14px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;cursor:pointer;
  color:var(--dim);
  transition:all var(--dur1) var(--ease);
  border:none;background:none;
  position:relative;
}
.sideItem:hover{color:var(--text);background:rgba(58,159,255,.1)}
.sideItem.active{
  color:var(--blue);
  background:rgba(58,159,255,.15);
  box-shadow:0 0 20px rgba(58,159,255,.15);
}
.sideItem.active::after{
  content:'';position:absolute;right:-1px;top:20%;bottom:20%;
  width:2px;border-radius:4px 0 0 4px;
  background:var(--blue);box-shadow:0 0 8px var(--blue);
}
.sideIcon{font-size:20px}
.sideLabel{font-size:9px;font-weight:700;letter-spacing:.3px}

/* ============================================================
   LAYOUT & PAGES
   ============================================================ */
.layout{
  position:relative;z-index:1;
  padding-top:calc(var(--top-h) + 14px);
  padding-bottom:calc(var(--nav-h) + 14px);
  min-height:100dvh;
}
@media(min-width:768px){
  .layout{padding-bottom:24px}
}

.page{display:none}
.page.active{display:block}

.pageInner{
  max-width:1520px;margin:0 auto;
  padding:0 18px;
  display:flex;flex-direction:column;gap:14px;
}
@media(max-width:768px){
  .pageInner{padding:0 12px}
}

/* ============================================================
   KPI ROW
   ============================================================ */
.kpiRow{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:10px;
}
.kpiCard{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:14px;
  display:flex;flex-direction:column;gap:6px;
  transition:transform var(--dur2) var(--ease),box-shadow var(--dur2) var(--ease);
  cursor:default;
}
.kpiCard:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.kpiLabel{font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
.kpiValue{font-size:28px;font-weight:900;line-height:1;font-variant-numeric:tabular-nums}
.kpiDelta{font-size:11px;color:var(--dim)}
.kpiCard.kpi-g .kpiValue{color:var(--green)}
.kpiCard.kpi-b .kpiValue{color:var(--blue)}
.kpiCard.kpi-r .kpiValue{color:var(--red)}
.kpiCard.kpi-y .kpiValue{color:var(--yellow)}
.kpiCard.kpi-p .kpiValue{color:var(--purple)}

/* ============================================================
   SECTOR CARDS
   ============================================================ */
.sectorRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:480px){.sectorRow{grid-template-columns:1fr}}

.sectorCard{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:16px;
  cursor:pointer;
  transition:all var(--dur2) var(--ease);
  position:relative;overflow:hidden;
}
.sectorCard::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent,rgba(255,255,255,.03));
  pointer-events:none;
}
.sectorCard:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.sectorCard.active{
  border-color:rgba(58,159,255,.7);
  background:linear-gradient(160deg,rgba(58,159,255,.15),var(--card));
  box-shadow:0 0 0 1px rgba(58,159,255,.3) inset,0 0 40px rgba(58,159,255,.2),var(--shadow);
}
.sectorName{font-size:15px;font-weight:900;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.sectorDot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sectorGrid{display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
.sectorStat{display:flex;flex-direction:column;gap:2px}
.sstatLabel{font-size:10px;color:var(--dim);font-weight:700;letter-spacing:.3px}
.sstatVal{font-size:15px;font-weight:900}

/* ============================================================
   TECH CARDS GRID
   ============================================================ */
.techGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:12px;
}
.techCard{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:14px;
  cursor:pointer;
  transition:all var(--dur2) var(--ease);
  position:relative;overflow:hidden;
}
.techCard::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(135deg,rgba(255,255,255,.025) 0%,transparent 60%);
}
.techCard:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.techCard.shift-M{
  border-color:rgba(29,232,122,.35);
  background:linear-gradient(160deg,rgba(29,232,122,.1),var(--card) 70%);
}
.techCard.shift-T{
  border-color:rgba(255,210,77,.35);
  background:linear-gradient(160deg,rgba(255,210,77,.09),var(--card) 70%);
}
.techCard.shift-N{
  border-color:rgba(185,79,255,.35);
  background:linear-gradient(160deg,rgba(185,79,255,.1),var(--card) 70%);
}
.techCard.shift-D{opacity:.55}
.techCard.guard{
  outline:2px solid rgba(255,140,66,.55);
  box-shadow:0 0 0 1px rgba(255,140,66,.2) inset,0 0 30px rgba(255,140,66,.15);
}

.techHead{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:10px}
.techName{font-size:14px;font-weight:900;line-height:1.2}
.techSub{font-size:11px;color:var(--muted);margin-top:2px}
.badgeRow{display:flex;gap:6px;flex-wrap:wrap}
.badge{
  font-size:11px;
  border:1px solid var(--line);
  background:rgba(14,24,48,.6);
  border-radius:999px;
  padding:4px 9px;
  font-weight:700;
  color:var(--muted);
}
.badge.shift{
  color:var(--text);
}
.badge.M{background:rgba(29,232,122,.2);border-color:rgba(29,232,122,.4);color:#98ffc0}
.badge.T{background:rgba(255,210,77,.18);border-color:rgba(255,210,77,.4);color:#ffe99d}
.badge.N{background:rgba(185,79,255,.18);border-color:rgba(185,79,255,.4);color:#d8aaff}
.badge.D{background:rgba(127,138,166,.15);border-color:rgba(127,138,166,.3);color:#9ab0d8}
.badge.guard{background:rgba(255,140,66,.2);border-color:rgba(255,140,66,.45);color:#ffd0a0;font-weight:900}
.badge.phone{background:rgba(58,159,255,.15);border-color:rgba(58,159,255,.4);color:#b0d4ff}

.techTimeline{
  margin-top:10px;
  height:28px;
  border-radius:8px;
  background:rgba(14,24,48,.8);
  border:1px solid var(--line);
  overflow:hidden;
  display:flex;position:relative;
}
.tlBlock{
  height:100%;
  display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:700;letter-spacing:.2px;
  white-space:nowrap;overflow:hidden;
  transition:filter 120ms;
}
.tlBlock:hover{filter:brightness(1.2)}
.tlBlock.free{background:rgba(29,232,122,.25)}
.tlBlock.busy{background:rgba(255,77,99,.3)}
.tlBlock.ot{background:rgba(58,159,255,.35)}
.tlBlock.break{background:rgba(127,138,166,.2)}

.loadBar{
  margin-top:8px;
  height:4px;border-radius:2px;
  background:var(--line);
  overflow:hidden;
}
.loadFill{
  height:100%;border-radius:2px;
  transition:width 600ms var(--ease);
  background:linear-gradient(90deg,var(--green),var(--blue));
}
.loadLabel{
  display:flex;justify-content:space-between;
  font-size:10px;color:var(--dim);margin-top:4px;
}

/* ============================================================
   TASK TRAY (Bandeja)
   ============================================================ */
.board{
  display:grid;
  grid-template-columns:280px 1fr;
  gap:12px;
}
@media(max-width:860px){.board{grid-template-columns:1fr}}

.tray{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:14px;
  display:flex;flex-direction:column;gap:12px;
  max-height:calc(100vh - 200px);overflow-y:auto;
}
.trayHead{display:flex;justify-content:space-between;align-items:center}
.trayHead h3{font-size:14px;font-weight:900;margin:0}

.trayGroup{display:flex;flex-direction:column;gap:6px}
.trayTitle{
  font-size:11px;font-weight:900;letter-spacing:.5px;
  text-transform:uppercase;padding:4px 0;
  border-bottom:1px solid var(--line);
  margin-bottom:2px;
}
.trayTitle.red{color:var(--red)}
.trayTitle.yellow{color:var(--yellow)}
.trayTitle.blue{color:var(--blue)}

.guardPhonePanel{
  margin-top:10px;padding:10px;border:1px dashed rgba(58,159,255,.35);border-radius:12px;
  background:linear-gradient(145deg,rgba(12,24,50,.78),rgba(9,17,34,.78));
}
.guardPhoneTitle{font-size:12px;font-weight:800;color:#9fd8ff;margin-bottom:8px}
.guardPhoneGrid{display:grid;gap:8px}
.guardPhoneItem{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:11px;color:var(--muted)}
.guardPhoneItem b{color:var(--text);font-size:12px}
.dayNotesWrap{margin-top:10px;padding-top:10px;border-top:1px solid var(--line)}
.dayNotesWrap textarea{min-height:80px;resize:vertical}
.noteHint{font-size:11px;color:var(--muted);margin-top:4px}
.phoneShiftGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
@media(max-width:640px){.phoneShiftGrid{grid-template-columns:1fr}}

.taskCard{
  border-radius:12px;
  padding:10px 12px;
  border:1px solid var(--line);
  background:rgba(14,24,48,.9);
  cursor:grab;
  transition:all var(--dur1) var(--ease);
  position:relative;
}
.taskCard:active{cursor:grabbing;transform:scale(.98)}
.taskCard:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
.taskCard .tt{font-size:13px;font-weight:800;line-height:1.3}
.taskCard .td{font-size:11px;color:var(--muted);margin-top:2px}
.taskCard.corr{border-left:3px solid var(--red)}
.taskCard.prev{border-left:3px solid var(--yellow)}
.taskCard.ot{border-left:3px solid var(--blue)}

/* ============================================================
   KANBAN (OTs / Incidencias)
   ============================================================ */
.kanban{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
@media(max-width:640px){.kanban{grid-template-columns:1fr}}

.kanCol{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:12px;
  min-height:200px;
  display:flex;flex-direction:column;gap:8px;
}
.kanCol[data-status="Pendiente"]{border-color:rgba(255,210,77,.2);background:rgba(255,210,77,.03)}
.kanCol[data-status="En curso"]{border-color:rgba(58,159,255,.2);background:rgba(58,159,255,.03)}
.kanCol[data-status="Cerrada"]{border-color:rgba(29,232,122,.2);background:rgba(29,232,122,.03)}

.kanHead{
  font-size:12px;font-weight:900;letter-spacing:.4px;text-transform:uppercase;
  display:flex;align-items:center;justify-content:space-between;
  padding-bottom:8px;border-bottom:1px solid var(--line);
}
.kanHead .count{
  font-size:11px;
  background:rgba(255,255,255,.08);
  border-radius:999px;
  padding:2px 8px;
}
.kanCol[data-status="Pendiente"] .kanHead{color:var(--yellow)}
.kanCol[data-status="En curso"] .kanHead{color:var(--blue)}
.kanCol[data-status="Cerrada"] .kanHead{color:var(--green)}

.kanCard{
  background:rgba(14,24,48,.9);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
  transition:all var(--dur1) var(--ease);
}
.kanCard:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm);border-color:var(--line2)}
.kanCard .kct{font-size:13px;font-weight:800}
.kanCard .kcd{font-size:11px;color:var(--muted);margin-top:3px}
.kanCard .kcm{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.priority-alta .kct::before{content:'üî¥ '}
.priority-media .kct::before{content:'üü° '}
.priority-baja .kct::before{content:'üü¢ '}

/* ============================================================
   PANEL DE GUARDIAS
   ============================================================ */
.guardPanel{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:12px;
}
.guardCard{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:14px;
  transition:all var(--dur2) var(--ease);
}
.guardCard.active-guard{
  border-color:rgba(255,140,66,.6);
  background:linear-gradient(160deg,rgba(255,140,66,.12),var(--card));
  box-shadow:0 0 30px rgba(255,140,66,.15);
}
.guardSector{font-size:11px;color:var(--dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.guardName{font-size:16px;font-weight:900;margin-bottom:6px}
.guardPhone{
  display:flex;align-items:center;gap:8px;
}
.guardPhone a{
  font-family:'JetBrains Mono',monospace;
  font-size:14px;font-weight:700;color:var(--blue);
  text-decoration:none;
  transition:color var(--dur1);
}
.guardPhone a:hover{color:#7fc6ff}

/* ============================================================
   WEEK CALENDAR
   ============================================================ */
.calWrap{overflow-x:auto}
.calTable{
  min-width:660px;
  display:flex;flex-direction:column;gap:5px;
}
.calHeader,.calRow{
  display:grid;
  grid-template-columns:minmax(180px,1.5fr) repeat(7,minmax(84px,1fr));
  gap:5px;align-items:center;
}
.calTechHead,.calTech{
  padding:11px 12px;
  border-radius:var(--r-sm);
  border:1px solid var(--line);
  background:rgba(14,24,48,.8);
  font-size:14px;font-weight:800;
  letter-spacing:.2px;
  text-shadow:0 1px 1px rgba(0,0,0,.25);
}
.calHeadCell{
  padding:11px 8px;border-radius:var(--r-sm);
  border:1px solid var(--line);
  background:rgba(14,24,48,.8);
  text-align:center;font-size:14px;font-weight:800;
  color:#cde4ff;
  letter-spacing:.25px;
}
.calCell{
  padding:12px 8px;border-radius:var(--r-sm);
  border:1px solid var(--line);
  text-align:center;font-size:15px;font-weight:800;
  letter-spacing:.35px;
  cursor:pointer;
  transition:all var(--dur1) var(--ease);
  text-shadow:0 1px 2px rgba(0,0,0,.35);
}
.calCell:hover{filter:brightness(1.15)}
.calCell.editable{cursor:pointer}
.calCell.readonly{cursor:default}
.calCell.M{background:rgba(29,232,122,.3);color:#98ffc0;border-color:rgba(29,232,122,.4)}
.calCell.T{background:rgba(255,210,77,.28);color:#ffe99d;border-color:rgba(255,210,77,.4)}
.calCell.N{background:rgba(185,79,255,.28);color:#d8aaff;border-color:rgba(185,79,255,.4)}
.calCell.D{background:rgba(127,138,166,.18);color:#9ab0d8;border-color:rgba(127,138,166,.25)}
.calCell.todayCol{
  outline:2px solid rgba(255,200,0,.7);
  box-shadow:0 0 0 1px rgba(255,200,0,.3) inset,0 0 14px rgba(255,200,0,.2);
}
.calHeadCell.todayCol{
  background:rgba(255,200,0,.15);color:#ffd34d;
  border-color:rgba(255,200,0,.4);
}

/* ============================================================
   MESSAGES / CENTRAL LOG
   ============================================================ */
.msgList{display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto}
.msgItem{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  animation:riseIn var(--dur3) var(--ease) both;
}
.msgHead{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.msgAvatar{
  width:28px;height:28px;border-radius:50%;
  background:linear-gradient(135deg,#1347ff,#1de87a);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:900;flex-shrink:0;
}
.msgAuthor{font-size:13px;font-weight:800}
.msgTime{font-size:11px;color:var(--dim);margin-left:auto}
.msgText{font-size:13px;line-height:1.5;color:#cde4ff}
.msgTag{font-size:10px;background:rgba(58,159,255,.15);border:1px solid rgba(58,159,255,.3);border-radius:999px;padding:2px 8px;color:#a0c8ff;font-weight:700}

/* ============================================================
   MODAL
   ============================================================ */
#backdrop{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.6);
  opacity:0;pointer-events:none;
  transition:opacity var(--dur2) var(--ease);
  backdrop-filter:blur(4px);
}
#backdrop.open{opacity:1;pointer-events:auto}

.modal{
  position:fixed;inset:0;z-index:201;
  display:flex;align-items:center;justify-content:center;
  pointer-events:none;padding:16px;
}
.modalCard{
  background:var(--card2);
  border:1px solid var(--line2);
  border-radius:20px;
  padding:24px;
  width:100%;max-width:560px;
  max-height:90vh;overflow-y:auto;
  box-shadow:0 40px 100px rgba(0,0,0,.6);
  opacity:0;transform:translateY(12px) scale(.98);
  transition:opacity var(--dur2) var(--ease),transform var(--dur2) var(--ease);
}
#modalTask .modalCard{max-width:720px}
@media(max-width:768px){
  #modalTask .modalCard{max-width:100%;padding:16px}
}
.modal.open .modalCard{
  opacity:1;transform:translateY(0) scale(1);
  pointer-events:auto;
}
.modalHead{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:20px;
  padding-bottom:14px;
  border-bottom:1px solid var(--line);
}
.modalTitle{font-size:16px;font-weight:900}
.btnClose{
  width:32px;height:32px;border-radius:var(--r-sm);
  background:rgba(255,255,255,.06);border:1px solid var(--line);
  color:var(--muted);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;
  transition:all var(--dur1) var(--ease);
}
.btnClose:hover{background:rgba(255,77,99,.2);border-color:rgba(255,77,99,.4);color:var(--red)}

/* ============================================================
   FORMS
   ============================================================ */
.formGrid{display:grid;gap:12px}
.formRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:480px){.formRow{grid-template-columns:1fr}}
.formGroup{display:flex;flex-direction:column;gap:5px}
.label{font-size:11px;font-weight:800;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
.input,.select,.textarea{
  background:rgba(8,15,32,.9);
  border:1px solid var(--line);
  border-radius:var(--r-sm);
  color:var(--text);
  font:500 13px 'Outfit',sans-serif;
  padding:10px 12px;
  transition:border-color var(--dur1) var(--ease),box-shadow var(--dur1) var(--ease);
}
.input:focus,.select:focus,.textarea:focus{
  outline:none;
  border-color:rgba(58,159,255,.6);
  box-shadow:0 0 0 3px rgba(58,159,255,.1);
}
.textarea{resize:vertical;min-height:80px}
.select{cursor:pointer}

.btn{
  border:1px solid var(--line);
  background:rgba(14,24,48,.8);
  color:var(--text);
  padding:10px 16px;
  border-radius:var(--r-sm);
  cursor:pointer;
  font:700 13px 'Outfit',sans-serif;
  transition:all var(--dur1) var(--ease);
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn:active{transform:scale(.98)}
.btn.primary{background:rgba(58,159,255,.2);border-color:rgba(58,159,255,.5);color:#a8d4ff}
.btn.primary:hover{background:rgba(58,159,255,.35);box-shadow:0 0 20px rgba(58,159,255,.2)}
.btn.success{background:rgba(29,232,122,.15);border-color:rgba(29,232,122,.4);color:#98ffc0}
.btn.danger{background:rgba(255,77,99,.15);border-color:rgba(255,77,99,.4);color:#ffaab0}
.btn.sm{padding:7px 12px;font-size:12px}
.btn.block{width:100%}
.btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}

/* ============================================================
   SECTION HEADER
   ============================================================ */
.sectionHead{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;flex-wrap:wrap;
}
.sectionTitle{
  font-size:18px;font-weight:900;
  display:flex;align-items:center;gap:8px;
}
.sectionTitle .dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--blue);
  box-shadow:0 0 10px var(--blue);
  animation:pulse 2.5s ease-in-out infinite;
}

/* ============================================================
   IMPORT EXCEL ZONE
   ============================================================ */
.importZone{
  border:2px dashed var(--line2);
  border-radius:var(--r);
  padding:32px;
  text-align:center;
  transition:all var(--dur2) var(--ease);
  cursor:pointer;
  position:relative;
}
.importZone:hover,.importZone.over{
  border-color:rgba(58,159,255,.6);
  background:rgba(58,159,255,.06);
}
.importZone input[type=file]{
  position:absolute;inset:0;opacity:0;cursor:pointer;
}
.importIcon{font-size:36px;margin-bottom:8px}
.importTitle{font-size:14px;font-weight:800;margin-bottom:4px}
.importSub{font-size:12px;color:var(--muted)}

/* ============================================================
   TOAST
   ============================================================ */
#toast{
  position:fixed;bottom:calc(var(--nav-h) + 16px);left:50%;
  transform:translateX(-50%) translateY(8px);
  opacity:0;
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(10px);
  color:var(--text);
  font:700 13px 'Outfit',sans-serif;
  padding:10px 18px;
  border-radius:999px;
  border:1px solid var(--line2);
  z-index:999;
  white-space:nowrap;
  pointer-events:none;
  transition:opacity var(--dur2) var(--ease),transform var(--dur2) var(--ease);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
@media(min-width:768px){#toast{bottom:24px}}

/* ============================================================
   SCROLL & UTILITY
   ============================================================ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--line2);border-radius:4px}

.section{
  position:relative;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:16px;
}
.section:hover{border-color:rgba(58,159,255,.45);box-shadow:0 0 0 1px rgba(58,159,255,.15),var(--shadow)}
.section::before{
  content:'';position:absolute;left:0;right:0;top:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--blue),var(--green),var(--purple),transparent);
  opacity:.72;animation:scanLine 6s linear infinite;
}
.section::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(120deg,transparent 35%,rgba(58,159,255,.11) 50%,transparent 65%);
  transform:translateX(-120%);animation:shineSweep 9s ease-in-out infinite;
}
.muted{color:var(--muted);font-size:12px}
.empty{
  text-align:center;padding:40px;color:var(--dim);
  font-size:13px;
}
.dot-live{
  display:inline-block;width:8px;height:8px;border-radius:50%;
  background:var(--green);box-shadow:0 0 8px var(--green);
  animation:pulse 2s ease-in-out infinite;
}

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes riseIn{
  from{opacity:0;transform:translateY(8px) scale(.99);filter:blur(2px)}
  to{opacity:1;transform:translateY(0) scale(1);filter:blur(0)}
}
@keyframes pulse{
  0%,100%{opacity:.6;transform:scale(1)}
  50%{opacity:1;transform:scale(1.15)}
}
@keyframes shimmer{
  0%{background-position:200% 0}100%{background-position:-200% 0}
}
@keyframes scanLine{
  0%,100%{transform:translateX(-25%)}
  50%{transform:translateX(25%)}
}
@keyframes shineSweep{
  0%,70%,100%{transform:translateX(-130%)}
  35%{transform:translateX(130%)}
}
.enter{animation:riseIn var(--dur3) var(--ease) both}
.enter-d1{animation-delay:60ms}
.enter-d2{animation-delay:120ms}
.enter-d3{animation-delay:180ms}
.enter-d4{animation-delay:240ms}
.enter-d5{animation-delay:300ms}

/* ============================================================
   LOGIN
   ============================================================ */
#loginOverlay{
  position:fixed;inset:0;z-index:500;
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
#loginOverlay.hidden{display:none}
.loginBg{
  position:absolute;inset:0;
  background:
    radial-gradient(ellipse 800px 600px at 30% 0%,rgba(30,60,180,.18),transparent),
    radial-gradient(ellipse 600px 400px at 80% 100%,rgba(185,79,255,.1),transparent),
    var(--bg);
}
.loginCard{
  position:relative;z-index:1;
  background:var(--card2);
  border:1px solid var(--line2);
  border-radius:24px;
  padding:32px;
  width:100%;max-width:400px;
  box-shadow:0 40px 100px rgba(0,0,0,.7);
  animation:riseIn var(--dur3) var(--ease) both;
}
.loginBrand{
  display:flex;align-items:center;gap:14px;margin-bottom:28px;
}
.loginLogoB{
  width:48px;height:48px;border-radius:14px;flex-shrink:0;
  background:linear-gradient(135deg,#1347ff,#1de87a);
  display:flex;align-items:center;justify-content:center;
  font-size:24px;
  box-shadow:0 0 30px rgba(29,232,122,.3);
}
.loginTitle{font-size:22px;font-weight:900;line-height:1}
.loginSub{font-size:12px;color:var(--muted);margin-top:4px}
.loginTabs{
  display:grid;grid-template-columns:1fr 1fr;
  gap:8px;margin-bottom:20px;
}
.loginTab{
  padding:10px;border-radius:var(--r-sm);
  border:1px solid var(--line);
  background:rgba(14,24,48,.6);
  color:var(--muted);font:700 13px 'Outfit',sans-serif;
  cursor:pointer;
  transition:all var(--dur1) var(--ease);
}
.loginTab.on{
  background:rgba(58,159,255,.2);border-color:rgba(58,159,255,.5);color:#a8d4ff;
}
.loginHint{font-size:12px;color:var(--muted);text-align:center;min-height:18px}

/* ============================================================
   SECTOR FILTER BAR
   ============================================================ */
.filterBar{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
}
.filterChip{
  border:1px solid var(--line);
  background:rgba(14,24,48,.6);
  color:var(--muted);font:700 12px 'Outfit',sans-serif;
  border-radius:999px;padding:6px 14px;
  cursor:pointer;
  transition:all var(--dur1) var(--ease);
}
.filterChip.active{
  background:rgba(58,159,255,.2);border-color:rgba(58,159,255,.5);color:#a8d4ff;
}
.filterChip.elec.active{
  background:rgba(255,210,77,.15);border-color:rgba(255,210,77,.4);color:#ffe99d;
}
.filterChip.font.active{
  background:rgba(58,159,255,.15);border-color:rgba(58,159,255,.4);color:#a8d4ff;
}
.filterChip.mec.active{
  background:rgba(255,140,66,.16);border-color:rgba(255,140,66,.45);color:#ffd5b8;
}
.filterChip.cli.active{
  background:rgba(185,79,255,.16);border-color:rgba(185,79,255,.45);color:#e2b8ff;
}

/* ============================================================
   MONTH CALENDAR
   ============================================================ */
.monthGrid{
  display:grid;grid-template-columns:repeat(7,1fr);gap:6px;
}
.monthMeta{
  display:flex;align-items:flex-end;justify-content:space-between;
  margin-bottom:12px;
}
.monthTitle{
  font-size:18px;font-weight:900;letter-spacing:.35px;color:#d9ebff;
  text-shadow:0 2px 4px rgba(0,0,0,.4);
  text-transform:capitalize;
}
.monthTag{
  font-size:11px;font-weight:800;color:#93f6bc;
  border:1px solid rgba(29,232,122,.35);
  background:rgba(29,232,122,.12);
  border-radius:999px;padding:4px 10px;
}
.monthDay{
  border-radius:8px;border:1px solid rgba(255,255,255,.06);
  cursor:pointer;transition:transform var(--dur1) var(--ease),box-shadow var(--dur1) var(--ease);
  padding:10px 9px;font-size:12px;min-height:76px;
  display:flex;flex-direction:column;justify-content:flex-start;
  line-height:1.2;
}
.monthDay .dayNum{font-size:18px;font-weight:900;opacity:.95;letter-spacing:.3px}
.monthDay small{margin-top:6px;font-size:11px;font-weight:800;letter-spacing:.3px;opacity:.95}
.monthDay.today{
  outline:2px solid rgba(58,159,255,.75);
  box-shadow:0 0 0 1px rgba(58,159,255,.45) inset,0 0 16px rgba(58,159,255,.25);
  transform:translateY(-2px);
}
.monthDay.M{background:rgba(29,232,122,.2);color:#98ffc0}
.monthDay.T{background:rgba(255,210,77,.18);color:#ffe99d}
.monthDay.N{background:rgba(185,79,255,.18);color:#d8aaff}
.monthDay.D{background:rgba(127,138,166,.15);color:#9ab0d8}
.monthDay.none{background:rgba(58,159,255,.06);color:var(--dim)}
.monthDay:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.25)}
.monthDay.noteSelected{outline:2px solid rgba(29,232,122,.75);box-shadow:0 0 0 1px rgba(29,232,122,.45) inset,0 0 16px rgba(29,232,122,.22)}

/* ============================================================
   PULSE DOT ANIMATED
   ============================================================ */
.logoDot{
  display:inline-block;
  width:10px;height:10px;border-radius:50%;
  background:var(--green);
  box-shadow:0 0 12px rgba(29,232,122,.5);
  animation:pulseDot 2.5s ease-in-out infinite;
}
@keyframes pulseDot{
  0%,100%{box-shadow:0 0 8px rgba(29,232,122,.4)}
  50%{box-shadow:0 0 24px rgba(29,232,122,.9),0 0 48px rgba(29,232,122,.3)}
}

/* PAGE TABS for mobile */
.pageTabs{
  display:flex;gap:6px;overflow-x:auto;
  padding:0 14px 10px;
  scrollbar-width:none;
  margin-top:-4px;
}
.pageTabs::-webkit-scrollbar{display:none}
.pageTab{
  border:1px solid var(--line);
  background:rgba(14,24,48,.6);
  color:var(--muted);font:700 12px 'Outfit',sans-serif;
  border-radius:999px;padding:6px 14px;
  cursor:pointer;white-space:nowrap;
  transition:all var(--dur1) var(--ease);
}
.pageTab.active{
  background:rgba(58,159,255,.2);border-color:rgba(58,159,255,.5);color:#a8d4ff;
}

/* Incidence severity */
.sev-high{color:var(--red);font-weight:900}
.sev-med{color:var(--yellow)}
.sev-low{color:var(--green)}

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media(max-width:768px){
  .techGrid{grid-template-columns:1fr}
  .kpiRow{grid-template-columns:repeat(2,1fr)}
  .board{grid-template-columns:1fr}
  .tray{max-height:none}
  .kanban{grid-template-columns:1fr}
  .guardPanel{grid-template-columns:1fr}
  body{padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom))}
}
@media(max-width:480px){
  .clock{font-size:14px}
  .brandName{font-size:15px}
  .topSearch{max-width:120px}
}
</style>
</head>
<body>

<div id="ambience"></div>
<div id="gridLines"></div>

<!-- ============================================================
     LOGIN OVERLAY
     ============================================================ -->
<div id="loginOverlay">
  <div class="loginBg"></div>
  <div class="loginCard">
    <div class="loginBrand">
      <div class="loginLogoB">‚ö°</div>
      <div>
        <div class="loginTitle">IsivoltPro</div>
        <div class="loginSub">Panel Central de Mantenimiento</div>
      </div>
    </div>

    <div class="loginTabs">
      <button class="loginTab on" id="tabTech" type="button">üë∑ T√©cnico</button>
      <button class="loginTab" id="tabCoord" type="button">üëë Coordinador</button>
    </div>

    <div class="formGrid">
      <div class="formGroup">
        <label class="label">Selecciona usuario</label>
        <select id="loginUser" class="select">
          <option value="">‚Äî Selecciona tu nombre ‚Äî</option>
        </select>
      </div>
      <div class="formGroup">
        <label class="label">Contrase√±a</label>
        <input id="loginPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button id="btnLogin" class="btn primary block" type="button">Entrar ‚Üí</button>
      <div class="loginHint" id="loginHint"></div>
    </div>
  </div>
</div>

<!-- ============================================================
     TOPBAR
     ============================================================ -->
<header class="topbar">
  <div class="brand">
    <div class="logoBubble">‚ö°</div>
    <div>
      <div class="brandName">IsivoltPro <span class="logoDot"></span></div>
      <div class="brandSub">Panel de Mantenimiento</div>
    </div>
  </div>

  <div class="topSearch">
    <input id="globalSearch" type="search" placeholder="Buscar t√©cnico, tarea‚Ä¶" autocomplete="off" />
  </div>

  <div class="topRight">
    <div class="clock" id="clock">--:--:--</div>
    <div class="datePill">
      <input type="date" id="datePicker" />
    </div>
    <button class="btnIcon" id="btnAddTask" title="Nueva tarea">Ôºã</button>
    <button class="btnIcon" id="btnMsg" title="Mensaje central">üí¨</button>
    <div class="userPill" id="userPill">
      <div class="avatar" id="userAvatar">?</div>
      <span class="userName" id="userName">‚Äî</span>
      <span>‚ñæ</span>
    </div>
    <button class="btnIcon" id="btnLogout" title="Cerrar sesi√≥n">üö™</button>
  </div>
</header>

<!-- ============================================================
     SIDEBAR (Desktop)
     ============================================================ -->
<nav class="sidebar" id="sidebar">
  <button class="sideItem active" data-page="planner">
    <span class="sideIcon">üìã</span>
    <span class="sideLabel">Panel</span>
  </button>
  <button class="sideItem" data-page="tech">
    <span class="sideIcon">üë∑</span>
    <span class="sideLabel">T√©cnicos</span>
  </button>
  <button class="sideItem" data-page="calendar">
    <span class="sideIcon">üìÖ</span>
    <span class="sideLabel">Turnos</span>
  </button>
  <button class="sideItem" data-page="incidents">
    <span class="sideIcon">üö®</span>
    <span class="sideLabel">Incid.</span>
  </button>
  <button class="sideItem" data-page="ots">
    <span class="sideIcon">üõ†Ô∏è</span>
    <span class="sideLabel">OTs</span>
  </button>
  <button class="sideItem" data-page="guards">
    <span class="sideIcon">üìû</span>
    <span class="sideLabel">Guardia</span>
  </button>
  <button class="sideItem" data-page="messages">
    <span class="sideIcon">üí¨</span>
    <span class="sideLabel">Mensajes</span>
  </button>
  <button class="sideItem hiddenCoord" data-page="admin">
    <span class="sideIcon">‚öôÔ∏è</span>
    <span class="sideLabel">Admin</span>
  </button>
</nav>

<!-- ============================================================
     MAIN LAYOUT
     ============================================================ -->
<main class="layout">

  <!-- Mobile page tabs -->
  <div class="pageTabs" id="pageTabs">
    <button class="pageTab active" data-page="planner">üìã Panel</button>
    <button class="pageTab" data-page="tech">üë∑ T√©cnicos</button>
    <button class="pageTab" data-page="calendar">üìÖ Turnos</button>
    <button class="pageTab" data-page="incidents">üö® Incidencias</button>
    <button class="pageTab" data-page="ots">üõ†Ô∏è OTs</button>
    <button class="pageTab" data-page="guards">üìû Guardia</button>
    <button class="pageTab" data-page="messages">üí¨ Mensajes</button>
    <button class="pageTab hiddenCoord" data-page="admin">‚öôÔ∏è Admin</button>
  </div>

  <!-- ===================== PAGE: PLANNER ===================== -->
  <div id="page-planner" class="page active">
    <div class="pageInner">

      <!-- Sector Filter -->
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot"></span>Panel Central</div>
        <div class="filterBar" id="sectorFilter">
          <button class="filterChip active" data-sector="all">Todos</button>
          <button class="filterChip elec" data-sector="Electricidad">‚ö° Electricidad</button>
          <button class="filterChip font" data-sector="Fontaner√≠a">üíß Fontaner√≠a</button>
          <button class="filterChip mec" data-sector="Mec√°nicos">üîß Mec√°nicos</button>
          <button class="filterChip cli" data-sector="Climatizaci√≥n">‚ùÑÔ∏è Climatizaci√≥n</button>
        </div>
      </div>

      <!-- KPI Row -->
      <div class="kpiRow" id="kpiRow">
        <div class="kpiCard kpi-b enter enter-d1">
          <div class="kpiLabel">T√©cnicos activos</div>
          <div class="kpiValue" id="kpiActive">0</div>
          <div class="kpiDelta">turno hoy</div>
        </div>
        <div class="kpiCard kpi-g enter enter-d2">
          <div class="kpiLabel">Disponibles</div>
          <div class="kpiValue" id="kpiFree">0</div>
          <div class="kpiDelta">sin tarea asignada</div>
        </div>
        <div class="kpiCard kpi-r enter enter-d3">
          <div class="kpiLabel">Correctivos</div>
          <div class="kpiValue" id="kpiCorr">0</div>
          <div class="kpiDelta">abiertos</div>
        </div>
        <div class="kpiCard kpi-y enter enter-d4">
          <div class="kpiLabel">Preventivos</div>
          <div class="kpiValue" id="kpiPrev">0</div>
          <div class="kpiDelta">planificados</div>
        </div>
        <div class="kpiCard kpi-p enter enter-d5">
          <div class="kpiLabel">OTs abiertas</div>
          <div class="kpiValue" id="kpiOT">0</div>
          <div class="kpiDelta">en curso</div>
        </div>
      </div>

      <!-- Sector summary -->
      <div class="sectorRow enter">
        <div class="sectorCard active" id="cardElec" data-sector="Electricidad">
          <div class="sectorName"><span class="sectorDot" style="background:var(--yellow);box-shadow:0 0 8px rgba(255,210,77,.5)"></span>Electricidad</div>
          <div class="sectorGrid">
            <div class="sectorStat"><div class="sstatLabel">Guardia</div><div class="sstatVal" id="elecGuard" style="color:var(--orange)">‚Äî</div></div>
            <div class="sectorStat"><div class="sstatLabel">Disponibles</div><div class="sstatVal" id="elecFree" style="color:var(--green)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Correctivos</div><div class="sstatVal" id="elecCorr" style="color:var(--red)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Carga</div><div class="sstatVal" id="elecLoad" style="color:var(--blue)">0%</div></div>
          </div>
        </div>
        <div class="sectorCard" id="cardFont" data-sector="Fontaner√≠a">
          <div class="sectorName"><span class="sectorDot" style="background:var(--blue);box-shadow:0 0 8px rgba(58,159,255,.5)"></span>Fontaner√≠a</div>
          <div class="sectorGrid">
            <div class="sectorStat"><div class="sstatLabel">Guardia</div><div class="sstatVal" id="fontGuard" style="color:var(--orange)">‚Äî</div></div>
            <div class="sectorStat"><div class="sstatLabel">Disponibles</div><div class="sstatVal" id="fontFree" style="color:var(--green)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Correctivos</div><div class="sstatVal" id="fontCorr" style="color:var(--red)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Carga</div><div class="sstatVal" id="fontLoad" style="color:var(--blue)">0%</div></div>
          </div>
        </div>
        <div class="sectorCard" id="cardMec" data-sector="Mec√°nicos">
          <div class="sectorName"><span class="sectorDot" style="background:var(--orange);box-shadow:0 0 8px rgba(255,140,66,.5)"></span>Mec√°nicos</div>
          <div class="sectorGrid">
            <div class="sectorStat"><div class="sstatLabel">Guardia</div><div class="sstatVal" id="mecGuard" style="color:var(--orange)">‚Äî</div></div>
            <div class="sectorStat"><div class="sstatLabel">Disponibles</div><div class="sstatVal" id="mecFree" style="color:var(--green)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Correctivos</div><div class="sstatVal" id="mecCorr" style="color:var(--red)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Carga</div><div class="sstatVal" id="mecLoad" style="color:var(--blue)">0%</div></div>
          </div>
        </div>
        <div class="sectorCard" id="cardCli" data-sector="Climatizaci√≥n">
          <div class="sectorName"><span class="sectorDot" style="background:var(--purple);box-shadow:0 0 8px rgba(185,79,255,.5)"></span>Climatizaci√≥n</div>
          <div class="sectorGrid">
            <div class="sectorStat"><div class="sstatLabel">Guardia</div><div class="sstatVal" id="cliGuard" style="color:var(--orange)">‚Äî</div></div>
            <div class="sectorStat"><div class="sstatLabel">Disponibles</div><div class="sstatVal" id="cliFree" style="color:var(--green)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Correctivos</div><div class="sstatVal" id="cliCorr" style="color:var(--red)">0</div></div>
            <div class="sectorStat"><div class="sstatLabel">Carga</div><div class="sstatVal" id="cliLoad" style="color:var(--blue)">0%</div></div>
          </div>
        </div>
      </div>

      <!-- Board: Tray + Tech Area -->
      <div class="board enter">
        <!-- Task Tray -->
        <div class="tray">
          <div class="trayHead">
            <h3>üì• Bandeja</h3>
            <button class="btn sm primary" id="btnNewTask">+ Nueva</button>
          </div>

          <div class="trayGroup">
            <div class="trayTitle red">üî¥ Correctivos</div>
            <div id="trayCorr" class="trayList">
              <div class="empty" style="padding:16px">Sin correctivos</div>
            </div>
          </div>
          <div class="trayGroup">
            <div class="trayTitle yellow">üü° Preventivos</div>
            <div id="trayPrev" class="trayList">
              <div class="empty" style="padding:16px">Sin preventivos</div>
            </div>
          </div>
          <div class="trayGroup">
            <div class="trayTitle blue">üîµ OT / Especiales</div>
            <div id="trayOT" class="trayList">
              <div class="empty" style="padding:16px">Sin OTs</div>
            </div>
          </div>

          <div class="guardPhonePanel">
            <div class="guardPhoneTitle">üìû Tel√©fono de guardia por turno (M/T/N por sector)</div>
            <div class="guardPhoneGrid" id="centralGuardPhones">
              <div class="empty" style="padding:10px">Sin tel√©fonos de guardia asignados</div>
            </div>
          </div>
        </div>

        <!-- Tech Area -->
        <div class="section">
          <div class="sectionHead" style="margin-bottom:12px">
            <div class="sectionTitle" style="font-size:15px">üë∑ T√©cnicos en turno</div>
            <select class="select" style="width:auto;padding:6px 10px;font-size:12px" id="techSectorFilter">
              <option value="all">Todos</option>
              <option value="Electricidad">Electricidad</option>
              <option value="Fontaner√≠a">Fontaner√≠a</option>
              <option value="Mec√°nicos">Mec√°nicos</option>
              <option value="Climatizaci√≥n">Climatizaci√≥n</option>
            </select>
          </div>
          <div class="techGrid" id="techGrid">
            <div class="empty">Importa un Excel de cuadrante para ver los t√©cnicos</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===================== PAGE: TECH ===================== -->
  <div id="page-tech" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot"></span>T√©cnicos</div>
        <div class="filterBar" id="techFilter">
          <button class="filterChip active" data-sector="all">Todos</button>
          <button class="filterChip elec" data-sector="Electricidad">‚ö° Electricidad</button>
          <button class="filterChip font" data-sector="Fontaner√≠a">üíß Fontaner√≠a</button>
          <button class="filterChip mec" data-sector="Mec√°nicos">üîß Mec√°nicos</button>
          <button class="filterChip cli" data-sector="Climatizaci√≥n">‚ùÑÔ∏è Climatizaci√≥n</button>
        </div>
      </div>
      <div class="techGrid enter" id="techGridFull" style="margin-top:4px">
        <div class="empty">Sin datos de cuadrante cargados</div>
      </div>
    </div>
  </div>

  <!-- ===================== PAGE: CALENDAR ===================== -->
  <div id="page-calendar" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot"></span>Cuadrante semanal</div>
        <div id="calendarControls" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="select" id="calSector" style="width:auto;padding:6px 10px;font-size:12px">
            <option value="Electricidad">Electricidad</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Mec√°nicos">Mec√°nicos</option>
            <option value="Climatizaci√≥n">Climatizaci√≥n</option>
          </select>
          <button class="btn sm" id="btnWeekPrev">‚óÄ</button>
          <span id="weekLabel" style="font-size:13px;font-weight:700">Semana</span>
          <button class="btn sm" id="btnWeekNext">‚ñ∂</button>
        </div>
      </div>

      <!-- Import zone -->
      <div class="section enter" id="calendarImportSection">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
          <span style="font-size:13px;font-weight:800">üì• Importar cuadrante Excel</span>
          <div style="display:flex;gap:8px">
            <label class="btn sm">
              üìÇ Subir Excel
              <input type="file" accept=".xlsx,.xls,.csv" id="rosterFile" hidden />
            </label>
            <button class="btn sm" type="button" id="btnExportRoster">‚¨áÔ∏è Descargar Excel</button>
          </div>
        </div>
        <div class="muted">Formato: primera columna = nombres, cabecera = d√≠as 1..31, celdas = turno (M/T/N/D)</div>
      </div>

      <!-- Weekly calendar -->
      <div class="section enter" id="calendarWeeklySection">
        <div class="calWrap">
          <div class="calTable" id="calTable">
            <div class="empty">Importa un Excel para ver el cuadrante</div>
          </div>
        </div>
      </div>

      <!-- Monthly heatmap -->
      <div class="section enter">
        <div class="monthMeta">
          <div class="monthTitle" id="monthTitle">Mes</div>
          <div class="monthTag" id="monthUpdated">Actualizado</div>
        </div>
        <div class="monthGrid" id="monthGrid">
          <div class="empty" style="grid-column:span 7">Sin datos</div>
        </div>
        <div class="dayNotesWrap">
          <div class="formGroup">
            <label class="label">üìù Nota del d√≠a seleccionado</label>
            <textarea class="textarea" id="dayNoteText" placeholder="Escribe una nota para el d√≠a seleccionado‚Ä¶" rows="3"></textarea>
            <div class="noteHint" id="dayNoteHint">Selecciona un d√≠a del calendario mensual para a√±adir una nota.</div>
          </div>
          <button class="btn sm primary" id="btnSaveDayNote">Guardar nota</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ===================== PAGE: INCIDENTS ===================== -->
  <div id="page-incidents" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot" style="background:var(--red);box-shadow:0 0 8px var(--red)"></span>Incidencias</div>
        <button class="btn primary" id="btnNewIncident">üö® Nueva incidencia</button>
      </div>

      <div class="kanban enter" id="incKanban">
        <div class="kanCol" data-status="Pendiente">
          <div class="kanHead">Pendiente <span class="count" id="cntIncPend">0</span></div>
          <div id="incPend"></div>
        </div>
        <div class="kanCol" data-status="En curso">
          <div class="kanHead">En curso <span class="count" id="cntIncCurso">0</span></div>
          <div id="incCurso"></div>
        </div>
        <div class="kanCol" data-status="Cerrada">
          <div class="kanHead">Cerrada <span class="count" id="cntIncCerrada">0</span></div>
          <div id="incCerrada"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== PAGE: OTs ===================== -->
  <div id="page-ots" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot" style="background:var(--blue);box-shadow:0 0 8px var(--blue)"></span>√ìrdenes de Trabajo</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label class="btn sm">
            üìÇ Importar OTs Excel
            <input type="file" accept=".xlsx,.xls,.csv" id="otFile" hidden />
          </label>
          <button class="btn primary sm" id="btnNewOT">üõ†Ô∏è Nueva OT</button>
        </div>
      </div>

      <div class="kanban enter" id="otKanban">
        <div class="kanCol" data-status="Pendiente">
          <div class="kanHead">Pendiente <span class="count" id="cntOTPend">0</span></div>
          <div id="otPend"></div>
        </div>
        <div class="kanCol" data-status="En curso">
          <div class="kanHead">En curso <span class="count" id="cntOTCurso">0</span></div>
          <div id="otCurso"></div>
        </div>
        <div class="kanCol" data-status="Cerrada">
          <div class="kanHead">Cerrada <span class="count" id="cntOTCerrada">0</span></div>
          <div id="otCerrada"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== PAGE: GUARDS ===================== -->
  <div id="page-guards" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot" style="background:var(--orange);box-shadow:0 0 8px var(--orange)"></span>Guardias</div>
        <button class="btn primary hiddenCoord" id="btnEditGuard">‚úèÔ∏è Editar guardias</button>
      </div>

      <div class="guardPanel enter" id="guardPanel">
        <div class="empty">Sin guardias configuradas</div>
      </div>

      <div class="section enter" style="margin-top:4px">
        <div style="font-size:13px;font-weight:800;margin-bottom:12px">üìû Directorio de tel√©fonos</div>
        <div id="phonesDir" class="techGrid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))">
          <div class="empty">Sin tel√©fonos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== PAGE: MESSAGES ===================== -->
  <div id="page-messages" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot" style="background:var(--purple);box-shadow:0 0 8px var(--purple)"></span>Mensajes Centrales</div>
      </div>

      <div class="section enter">
        <div class="formGrid" id="msgForm">
          <div class="formGroup">
            <label class="label">Mensaje</label>
            <textarea class="textarea" id="msgText" placeholder="Escribe un mensaje para todo el equipo‚Ä¶" rows="3"></textarea>
          </div>
          <div class="formRow">
            <div class="formGroup">
              <label class="label">Tipo</label>
              <select class="select" id="msgType">
                <option value="info">‚ÑπÔ∏è Info</option>
                <option value="alerta">‚ö†Ô∏è Alerta</option>
                <option value="urgente">üö® Urgente</option>
              </select>
            </div>
            <div class="formGroup">
              <label class="label">Sector</label>
              <select class="select" id="msgSector">
                <option value="all">Todos</option>
                <option value="Electricidad">Electricidad</option>
                <option value="Fontaner√≠a">Fontaner√≠a</option>
              </select>
            </div>
          </div>
          <button class="btn primary" id="btnSendMsg">Enviar mensaje ‚Üí</button>
        </div>
      </div>

      <div class="msgList enter" id="msgList">
        <div class="empty">Sin mensajes</div>
      </div>
    </div>
  </div>

  <!-- ===================== PAGE: ADMIN ===================== -->
  <div id="page-admin" class="page">
    <div class="pageInner">
      <div class="sectionHead enter">
        <div class="sectionTitle"><span class="dot" style="background:var(--muted)"></span>Administraci√≥n</div>
      </div>

      <!-- Import Excel zone -->
      <div class="section enter">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">üì• Base de datos Excel</div>
        <div class="importZone" id="importZoneAdmin">
          <input type="file" accept=".xlsx,.xls,.csv" id="adminExcelFile" />
          <div class="importIcon">üìä</div>
          <div class="importTitle">Arrastra o haz clic para subir Excel</div>
          <div class="importSub">Hojas: T√©cnicos, Turnos, Tel√©fonos, OTs, Incidencias</div>
        </div>
        <div id="importStatus" class="muted" style="margin-top:10px"></div>
      </div>

      <!-- Users -->
      <div class="section enter">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">üë• Usuarios y contrase√±as</div>
        <div class="formRow" style="margin-bottom:12px;max-width:620px">
          <select class="select" id="userCategoryFilter" style="max-width:220px">
            <option value="all">Todas las categor√≠as</option>
            <option value="Electricidad">Electricidad</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Mec√°nicos">Mec√°nicos</option>
            <option value="Climatizaci√≥n">Climatizaci√≥n</option>
          </select>
          <input class="input" id="userNameFilter" type="text" placeholder="Buscar t√©cnico por nombre" />
        </div>
        <div id="usersList" class="techGrid" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr))">
          <div class="empty">Sin usuarios</div>
        </div>
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--line)">
          <div style="font-size:13px;font-weight:800;margin-bottom:10px;color:var(--muted)">Contrase√±a del coordinador</div>
          <div class="formRow" style="max-width:400px">
            <input class="input" type="password" id="coordPass" placeholder="Nueva contrase√±a" />
            <button class="btn primary" id="btnSaveCoordPass">Guardar</button>
          </div>
        </div>
      </div>

      <!-- Backup -->
      <div class="section enter">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">üíæ Backup</div>
        <div class="btnRow">
          <button class="btn" id="btnExportBackup">‚¨áÔ∏è Exportar backup</button>
          <label class="btn">
            üì• Restaurar backup
            <input type="file" accept=".json" id="backupFile" hidden />
          </label>
          <button class="btn danger" id="btnClearAll">üóëÔ∏è Borrar todo</button>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- ============================================================
     BOTTOM NAV
     ============================================================ -->
<nav class="bottomNav">
  <button class="navItem active" data-page="planner">
    <span class="navIcon">üìã</span><span class="navLabel">Panel</span>
  </button>
  <button class="navItem" data-page="tech">
    <span class="navIcon">üë∑</span><span class="navLabel">T√©cnicos</span>
  </button>
  <button class="navItem" data-page="calendar">
    <span class="navIcon">üìÖ</span><span class="navLabel">Turnos</span>
  </button>
  <button class="navItem" data-page="incidents">
    <span class="navIcon">üö®</span><span class="navLabel">Incid.</span>
  </button>
  <button class="navItem" data-page="ots">
    <span class="navIcon">üõ†Ô∏è</span><span class="navLabel">OTs</span>
  </button>
  <button class="navItem" data-page="guards">
    <span class="navIcon">üìû</span><span class="navLabel">Guardia</span>
  </button>
</nav>

<!-- ============================================================
     BACKDROP & MODALS
     ============================================================ -->
<div id="backdrop"></div>

<!-- Modal: Nueva tarea -->
<div class="modal" id="modalTask">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">üìã Nueva tarea</div>
      <button class="btnClose" data-close="modalTask">‚úï</button>
    </div>
    <div class="formGrid">
      <div class="formRow">
        <div class="formGroup">
          <label class="label">Tipo</label>
          <select class="select" id="taskType">
            <option value="Correctivo">üî¥ Correctivo</option>
            <option value="Preventivo">üü° Preventivo</option>
            <option value="OT">üîµ OT</option>
          </select>
        </div>
        <div class="formGroup">
          <label class="label">Sector</label>
          <select class="select" id="taskSector">
            <option value="Electricidad">Electricidad</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Mec√°nicos">Mec√°nicos</option>
            <option value="Climatizaci√≥n">Climatizaci√≥n</option>
          </select>
        </div>
      </div>
      <div class="formGroup">
        <label class="label">T√≠tulo / Descripci√≥n</label>
        <input class="input" id="taskTitle" type="text" placeholder="Ej: Aver√≠a cuadro el√©ctrico sala 3" />
      </div>
      <div class="formRow">
        <div class="formGroup">
          <label class="label">T√©cnico asignado</label>
          <select class="select" id="taskTech">
            <option value="">Sin asignar</option>
          </select>
        </div>
        <div class="formGroup">
          <label class="label">Prioridad</label>
          <select class="select" id="taskPriority">
            <option value="alta">Alta</option>
            <option value="media">Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
      </div>
      <div class="formGroup">
        <label class="label">Nota</label>
        <textarea class="textarea" id="taskNote" placeholder="Detalles adicionales‚Ä¶" rows="2"></textarea>
      </div>
      <div class="btnRow">
        <button class="btn primary" id="btnSaveTask">Guardar tarea</button>
        <button class="btn" data-close="modalTask">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Nueva incidencia -->
<div class="modal" id="modalIncident">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">üö® Nueva incidencia</div>
      <button class="btnClose" data-close="modalIncident">‚úï</button>
    </div>
    <div class="formGrid">
      <div class="formRow">
        <div class="formGroup">
          <label class="label">Sector</label>
          <select class="select" id="incSector">
            <option value="Electricidad">Electricidad</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Mec√°nicos">Mec√°nicos</option>
            <option value="Climatizaci√≥n">Climatizaci√≥n</option>
          </select>
        </div>
        <div class="formGroup">
          <label class="label">Severidad</label>
          <select class="select" id="incSeverity">
            <option value="alta">üî¥ Alta</option>
            <option value="media">üü° Media</option>
            <option value="baja">üü¢ Baja</option>
          </select>
        </div>
      </div>
      <div class="formGroup">
        <label class="label">Descripci√≥n</label>
        <input class="input" id="incTitle" type="text" placeholder="Describe la incidencia‚Ä¶" />
      </div>
      <div class="formGroup">
        <label class="label">Ubicaci√≥n</label>
        <input class="input" id="incLocation" type="text" placeholder="Planta / Sala / Zona" />
      </div>
      <div class="formGroup">
        <label class="label">T√©cnico asignado</label>
        <select class="select" id="incTech">
          <option value="">Sin asignar</option>
        </select>
      </div>
      <div class="formGroup">
        <label class="label">Nota</label>
        <textarea class="textarea" id="incNote" placeholder="Observaciones‚Ä¶" rows="2"></textarea>
      </div>
      <div class="btnRow">
        <button class="btn danger" id="btnSaveIncident">Crear incidencia</button>
        <button class="btn" data-close="modalIncident">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Nueva OT -->
<div class="modal" id="modalOT">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">üõ†Ô∏è Nueva OT</div>
      <button class="btnClose" data-close="modalOT">‚úï</button>
    </div>
    <div class="formGrid">
      <div class="formRow">
        <div class="formGroup">
          <label class="label">N√∫mero OT</label>
          <input class="input" id="otNum" type="text" placeholder="OT-0001" />
        </div>
        <div class="formGroup">
          <label class="label">Sector</label>
          <select class="select" id="otSector">
            <option value="Electricidad">Electricidad</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Mec√°nicos">Mec√°nicos</option>
            <option value="Climatizaci√≥n">Climatizaci√≥n</option>
          </select>
        </div>
      </div>
      <div class="formGroup">
        <label class="label">Descripci√≥n</label>
        <input class="input" id="otTitle" type="text" placeholder="Descripci√≥n de la OT‚Ä¶" />
      </div>
      <div class="formRow">
        <div class="formGroup">
          <label class="label">T√©cnico</label>
          <select class="select" id="otTech">
            <option value="">Sin asignar</option>
          </select>
        </div>
        <div class="formGroup">
          <label class="label">Prioridad</label>
          <select class="select" id="otPriority">
            <option value="alta">Alta</option>
            <option value="media">Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
      </div>
      <div class="formGroup">
        <label class="label">Nota</label>
        <textarea class="textarea" id="otNote" placeholder="Observaciones‚Ä¶" rows="2"></textarea>
      </div>
      <div class="btnRow">
        <button class="btn primary" id="btnSaveOT">Crear OT</button>
        <button class="btn" data-close="modalOT">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Detail -->
<div class="modal" id="modalDetail">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle" id="detailTitle">Detalle</div>
      <button class="btnClose" data-close="modalDetail">‚úï</button>
    </div>
    <div id="detailBody" class="formGrid"></div>
  </div>
</div>

<!-- Modal: Edit guard -->
<div class="modal" id="modalGuard">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">üìû Editar guardias</div>
      <button class="btnClose" data-close="modalGuard">‚úï</button>
    </div>
    <div class="formGrid" id="guardForm">
      <div style="font-size:13px;color:var(--muted)">Selecciona la guardia del d√≠a para cada sector</div>
      <div style="font-size:12px;color:var(--dim)">Tel√©fono de guardia: solo t√©cnicos en turno de Ma√±ana / Tarde / Noche.</div>
      <div class="formGroup">
        <label class="label">Guardia Electricidad</label>
        <select class="select" id="guardElec">
          <option value="">‚Äî Sin guardia ‚Äî</option>
        </select>
      </div>
      <div class="formGroup">
        <label class="label">Guardia Fontaner√≠a</label>
        <select class="select" id="guardFont">
          <option value="">‚Äî Sin guardia ‚Äî</option>
        </select>
      </div>
      <div class="formGroup">
        <label class="label">Guardia Mec√°nicos</label>
        <select class="select" id="guardMec">
          <option value="">‚Äî Sin guardia ‚Äî</option>
        </select>
      </div>
      <div class="formGroup">
        <label class="label">Guardia Climatizaci√≥n</label>
        <select class="select" id="guardCli">
          <option value="">‚Äî Sin guardia ‚Äî</option>
        </select>
      </div>
      <div id="guardPhoneShiftForm"></div>
      <div class="btnRow">
        <button class="btn primary" id="btnSaveGuard">Guardar guardias</button>
        <button class="btn" data-close="modalGuard">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
// ============================================================
// STATE & STORAGE
// ============================================================
const LS_KEYS = {
  rosters:'isv_rosters_v14',
  tasks:'isv_tasks_v14',
  phones:'isv_phones_v14',
  incidents:'isv_incidents_v14',
  ots:'isv_ots_v14',
  messages:'isv_messages_v14',
  guards:'isv_guards_v14',
  users:'isv_users_v14',
  dayNotes:'isv_day_notes_v14',
  guardPhonesByShift:'isv_guard_phones_shift_v14',
  session:'isv_session_v14',
};

function lsGet(k){ try{return JSON.parse(localStorage.getItem(LS_KEYS[k])||'null')}catch{return null}}
function lsSet(k,v){ localStorage.setItem(LS_KEYS[k],JSON.stringify(v)) }

const ST = {
  rosters:  lsGet('rosters')   || {},  // { sector: { names:[], days:[], matrix:[[]] } }
  tasks:    lsGet('tasks')     || [],
  phones:   lsGet('phones')    || {},  // { sector: { name: phone } }
  incidents:lsGet('incidents') || [],
  ots:      lsGet('ots')       || [],
  messages: lsGet('messages')  || [],
  guards:   lsGet('guards')    || { Electricidad:'', Fontaner√≠a:'', Mec√°nicos:'', Climatizaci√≥n:'' },
  users:    lsGet('users')     || { coordinador: '1234', tecnicos: {} },
  dayNotes: lsGet('dayNotes')  || {},
  guardPhonesByShift: lsGet('guardPhonesByShift') || {},
  session:  lsGet('session')   || null,
};
const SECTORS=['Electricidad','Fontaner√≠a','Mec√°nicos','Climatizaci√≥n'];
['Electricidad','Fontaner√≠a','Mec√°nicos','Climatizaci√≥n'].forEach(sec=>{
  if(ST.guards[sec]===undefined) ST.guards[sec]='';
  if(!ST.guardPhonesByShift[sec]) ST.guardPhonesByShift[sec]={M:'',T:'',N:''};
});

// Default demo CSV
const DEMO_CSV = `Nombre,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28
SERGIO RAEZ MARTINEZ,D,M,M,M,M,D,T,T,N,D,D,M,M,D,D,T,N,D,D,D,D,D,M,M,M,M,D,T
SINUHE BAILON BAILON,T,N,D,D,M,M,D,D,T,N,D,D,D,D,D,D,M,M,M,M,M,D,D,T,N,D,D,M
CARLOS GARCIA ESPINOSA,D,T,N,D,D,D,D,M,M,N,D,D,M,M,D,M,T,N,D,D,M,D,D,M,T,N,D,T
MIGUEL LOPEZ DEL AGUILA,D,M,M,M,M,M,D,D,M,T,N,D,D,M,M,D,M,M,M,M,D,D,M,M,M,M,M,D
JONATHAN ORTEGA ROBLES,D,M,T,N,D,D,M,M,D,M,M,D,T,N,D,D,M,T,N,D,D,D,M,T,N,D,D,M
ANGELA GONZALEZ,M,D,M,M,M,M,D,D,M,M,T,N,D,D,D,D,M,M,M,D,T,D,D,M,M,M,D,T
ISICIO ZAFRA CANTOS,D,M,M,T,N,D,D,D,M,M,M,T,N,D,D,D,M,M,M,D,N,D,D,M,M,M,D,N
ANGEL SANCHEZ ROJAS,D,M,M,M,M,N,D,D,M,M,M,M,D,T,N,D,D,M,M,M,D,D,M,M,M,M,D,T
DAVID SEGURA JIMENEZ,D,M,M,M,D,T,N,N,D,D,M,M,M,M,D,M,M,M,M,M,D,D,M,M,M,M,D,N
OSCAR RODRIGUEZ,N,D,D,M,M,M,D,D,M,M,M,D,T,T,N,D,D,M,M,M,D,D,M,M,M,M,D,T`;

const DEMO_ELEC_CSV = `Nombre,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28
ANTONIO MEGIAS RUIZ,D,M,M,M,M,M,D,D,M,M,M,M,D,D,D,M,M,M,M,M,D,D,M,M,M,M,D,T
JUAN ARGUELLES BAREA,D,M,M,M,M,M,D,D,M,M,M,M,D,D,D,M,M,M,M,M,D,D,M,M,M,M,D,T
PEDRO LOZANO VERA,M,T,N,D,D,M,M,D,T,N,D,D,M,M,D,T,N,D,D,M,M,D,T,N,D,D,M,T
RAFAEL BLANCO RUIZ,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D
LUIS MARTIN GOMEZ,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M,T,N,D,D,M
ELENA RUIZ SANCHEZ,M,M,D,D,T,N,D,D,M,M,D,D,T,N,D,D,M,M,D,D,T,N,D,D,M,M,D,N`;

function saveAll(){
  Object.keys(ST).forEach(k=>lsSet(k,ST[k]));
}

// Load demo if empty
if(!SECTORS.some(sec=>ST.rosters[sec])){
  ST.rosters['Fontaner√≠a'] = parseRosterCSV(DEMO_CSV,'Fontaner√≠a');
  ST.rosters['Electricidad'] = parseRosterCSV(DEMO_ELEC_CSV,'Electricidad');
  saveAll();
}

// ============================================================
// HELPERS
// ============================================================
function $(id){ return document.getElementById(id) }
function todayISO(){
  const d=new Date();
  return new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
}
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6) }

function toLocalISO(dateObj){
  const local=new Date(dateObj.getTime()-dateObj.getTimezoneOffset()*60000);
  return local.toISOString().slice(0,10);
}
let selectedNoteDay='';

function toast(msg, ms=2000){
  const t=$('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.remove('show'),ms);
}

function animNum(el,to,dur=500){
  if(!el)return;
  const from=parseInt(el.textContent)||0;
  const start=performance.now();
  const step=t=>{
    const p=Math.min((t-start)/dur,1);
    const e=1-Math.pow(1-p,3);
    el.textContent=Math.round(from+(to-from)*e);
    if(p<1)requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

// ============================================================
// ROSTER / CSV PARSING
// ============================================================
function parseRosterCSV(text, sector){
  const lines=text.trim().split(/\r?\n/).filter(Boolean);
  const header=lines[0].split(',').map(s=>s.trim());
  const days=header.slice(1).map(Number);
  const names=[];
  const matrix=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(',').map(s=>s.trim());
    names.push(cols[0]);
    matrix.push(cols.slice(1));
  }
  return {sector,names,days,matrix};
}

function parseXLSX(file,sector,cb){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_csv(ws);
      cb(parseRosterCSV(rows,sector));
    }catch(err){
      toast('‚ùå Error leyendo Excel');
      console.error(err);
    }
  };
  reader.readAsBinaryString(file);
}

function parseOTsFromXLSX(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      // Try to find OT sheet
      let sheetName=wb.SheetNames.find(n=>/ot/i.test(n))||wb.SheetNames[0];
      const ws=wb.Sheets[sheetName];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
      rows.forEach(row=>{
        const ot={
          id:uid(),
          num:row['N√∫mero']||row['num']||row['OT']||'',
          title:row['Descripci√≥n']||row['titulo']||row['title']||'',
          sector:row['Sector']||'Electricidad',
          tech:row['T√©cnico']||row['tecnico']||'',
          priority:row['Prioridad']||row['priority']||'media',
          status:row['Estado']||'Pendiente',
          note:row['Nota']||row['nota']||'',
          created:new Date().toISOString(),
        };
        if(ot.title) ST.ots.push(ot);
      });
      saveAll();
      renderOTs();
      toast(`‚úÖ ${rows.length} OTs importadas`);
    }catch(err){
      toast('‚ùå Error leyendo Excel de OTs');
      console.error(err);
    }
  };
  reader.readAsBinaryString(file);
}

// Master Excel import (multiple sheets)
function parseMasterXLSX(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      let imported=[];

      wb.SheetNames.forEach(name=>{
        const ws=wb.Sheets[name];
        const lname=name.toLowerCase();
        if(/font|plomero/i.test(name)){
          const csv=XLSX.utils.sheet_to_csv(ws);
          ST.rosters['Fontaner√≠a']=parseRosterCSV(csv,'Fontaner√≠a');
          imported.push('Fontaner√≠a');
        } else if(/elec/i.test(name)){
          const csv=XLSX.utils.sheet_to_csv(ws);
          ST.rosters['Electricidad']=parseRosterCSV(csv,'Electricidad');
          imported.push('Electricidad');
        } else if(/ot|orden/i.test(name)){
          const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
          rows.forEach(row=>{
            if(row['Descripci√≥n']||row['titulo']){
              ST.ots.push({id:uid(),num:row['N√∫mero']||'',title:row['Descripci√≥n']||row['titulo']||'',
                sector:row['Sector']||'Electricidad',tech:row['T√©cnico']||'',
                priority:row['Prioridad']||'media',status:row['Estado']||'Pendiente',
                note:row['Nota']||'',created:new Date().toISOString()});
            }
          });
          imported.push('OTs');
        } else if(/tel|phone/i.test(name)){
          const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
          rows.forEach(row=>{
            const sec=row['Sector']||'Fontaner√≠a';
            const name2=row['Nombre']||row['nombre']||'';
            const phone=row['Tel√©fono']||row['telefono']||row['phone']||'';
            if(!ST.phones[sec]) ST.phones[sec]={};
            if(name2) ST.phones[sec][name2]=phone;
          });
          imported.push('Tel√©fonos');
        } else if(/incid/i.test(name)){
          const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
          rows.forEach(row=>{
            if(row['Descripci√≥n']||row['titulo']){
              ST.incidents.push({id:uid(),title:row['Descripci√≥n']||row['titulo']||'',
                sector:row['Sector']||'Electricidad',severity:row['Severidad']||'media',
                location:row['Ubicaci√≥n']||'',tech:row['T√©cnico']||'',
                status:row['Estado']||'Pendiente',note:row['Nota']||'',
                created:new Date().toISOString()});
            }
          });
          imported.push('Incidencias');
        }
      });

      saveAll();
      renderAll();
      $('importStatus').textContent=`‚úÖ Importado: ${imported.join(', ')}`;
      toast(`‚úÖ Excel importado (${imported.join(', ')})`);
    }catch(err){
      toast('‚ùå Error procesando Excel');
      console.error(err);
      $('importStatus').textContent='‚ùå Error: '+err.message;
    }
  };
  reader.readAsBinaryString(file);
}

// ============================================================
// SHIFT HELPERS
// ============================================================
const SHIFT_COLORS={M:'var(--green)',T:'var(--yellow)',N:'var(--purple)',D:'var(--dim)'};
const SHIFT_LABELS={M:'Ma√±ana',T:'Tarde',N:'Noche',D:'Descanso'};

const SHIFT_SEQUENCE=['M','T','N','D'];

function rotateShift(shift){
  const i=SHIFT_SEQUENCE.indexOf((shift||'D').split('/')[0]);
  return SHIFT_SEQUENCE[(i+1)%SHIFT_SEQUENCE.length];
}

function bindCalendarEdition(){
  document.querySelectorAll('#calTable .calCell.editable[data-tech][data-day]').forEach(cell=>{
    cell.addEventListener('click',()=>{
      const tech=cell.dataset.tech;
      const day=cell.dataset.day;
      const sector=cell.dataset.sector;
      const current=(getTechShift(sector,tech,day)||'D').split('/')[0];
      const next=rotateShift(current);
      const ok=confirm(`‚ö†Ô∏è Vas a cambiar el turno de ${tech} el ${day} de ${SHIFT_LABELS[current]||current} a ${SHIFT_LABELS[next]||next}. ¬øContinuar?`);
      if(!ok) return;
      const dayIdx=(ST.rosters[sector]?.days||[]).indexOf(day.slice(8));
      const rowIdx=(ST.rosters[sector]?.names||[]).findIndex(n=>n===tech);
      if(dayIdx<0 || rowIdx<0){
        toast('‚ö†Ô∏è No se pudo actualizar el turno');
        return;
      }
      ST.rosters[sector].matrix[rowIdx][dayIdx]=next;
      saveAll();
      renderCalendar();
      toast(`‚úÖ Turno actualizado: ${tech} ‚Üí ${SHIFT_LABELS[next]||next}`);
    });
  });
}
const SHIFT_SHORT={M:'M',T:'T',N:'N',D:'D'};

const SHIFT_ORDER={M:0,T:1,N:2,D:3};

function getRosterEntriesBySector(sec,date){
  const r=ST.rosters[sec];
  if(!r) return [];
  return r.names.map(name=>({
    name,
    sec,
    shift:getTechShift(sec,name,date)||'D'
  })).sort((a,b)=>{
    const byShift=(SHIFT_ORDER[a.shift]??99)-(SHIFT_ORDER[b.shift]??99);
    return byShift||a.name.localeCompare(b.name,'es',{sensitivity:'base'});
  });
}

function formatTechOption(tech){
  return `${tech.name} (${tech.sec} ¬∑ ${SHIFT_LABELS[tech.shift]||tech.shift})`;
}

function getTechShift(sector, techName, dateISO){
  const r=ST.rosters[sector];
  if(!r) return null;
  const {y,m,d}=isoToYMD(dateISO);
  const dayNum=d;
  const dayIdx=r.days.indexOf(dayNum);
  if(dayIdx<0) return null;
  const nameIdx=r.names.findIndex(n=>n.toLowerCase()===techName.toLowerCase());
  if(nameIdx<0) return null;
  const raw=r.matrix[nameIdx]?.[dayIdx]||'D';
  return raw.split('/')[0].trim();
}

function isoToYMD(iso){
  const [y,m,d]=iso.split('-').map(Number);
  return {y,m,d};
}

function getWeekDays(dateISO){
  const d=new Date(dateISO+'T00:00:00');
  const dow=d.getDay()||7;
  const mon=new Date(d);
  mon.setDate(d.getDate()-dow+1);
  const days=[];
  for(let i=0;i<7;i++){
    const dd=new Date(mon);
    dd.setDate(mon.getDate()+i);
    days.push(toLocalISO(dd));
  }
  return days;
}

// ============================================================
// AUTH
// ============================================================
let currentUser=ST.session;
const COORD_PASS_KEY='isv_coord_pass';

function checkLogin(role,name,pass){
  if(role==='coord'){
    const cp=localStorage.getItem(COORD_PASS_KEY)||ST.users.coordinador||'1234';
    return pass===cp;
  } else {
    const tp=ST.users.tecnicos?.[name];
    return pass===(tp||'1234');
  }
}

function doLogin(role,name,pass){
  if(checkLogin(role,name,pass)){
    currentUser={role,name};
    ST.session=currentUser;
    lsSet('session',currentUser);
    $('loginOverlay').classList.add('hidden');
    applyRoleUI();
    renderAll();
    toast(`üëã Bienvenido, ${name}`);
    return true;
  }
  return false;
}

function doLogout(){
  ST.session=null;
  lsSet('session',null);
  location.reload();
}

function applyRoleUI(){
  const isCoord=currentUser?.role==='coord';
  const allowedPages=isCoord
    ? ['planner','tech','calendar','incidents','ots','guards','messages','admin']
    : ['calendar','incidents','ots','messages'];

  document.querySelectorAll('.hiddenCoord').forEach(el=>{
    el.style.display=isCoord?'':'none';
  });

  document.querySelectorAll('[data-page]').forEach(el=>{
    const page=el.dataset.page;
    if(!page) return;
    el.style.display=allowedPages.includes(page)?'':'none';
  });

  $('msgForm').style.display=isCoord?'':'none';

  const title=document.querySelector('#page-calendar .sectionHead .sectionTitle');
  if(title) title.innerHTML=isCoord?'<span class="dot"></span>Cuadrante semanal':'<span class="dot"></span>Mi cuadrante mensual';

  const calControls=$('calendarControls');
  const calImport=$('calendarImportSection');
  const calWeekly=$('calendarWeeklySection');
  if(calControls) calControls.style.display=isCoord?'flex':'none';
  if(calImport) calImport.style.display=isCoord?'':'none';
  if(calWeekly) calWeekly.style.display=isCoord?'':'none';

  const name=currentUser?.name||'‚Äî';
  $('userName').textContent=name;
  $('userAvatar').textContent=name.charAt(0).toUpperCase();

  const preferredPage=allowedPages.includes(activePage)?activePage:allowedPages[0];
  if(activePage!==preferredPage){
    goPage(preferredPage);
  }
}

// ============================================================
// NAVIGATION
// ============================================================
let activePage='planner';

function goPage(page){
  const isCoord=currentUser?.role==='coord';
  const allowedPages=isCoord
    ? ['planner','tech','calendar','incidents','ots','guards','messages','admin']
    : ['calendar','incidents','ots','messages'];
  if(!allowedPages.includes(page)) page=allowedPages[0];

  activePage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const pg=$(  `page-${page}`);
  if(pg){ pg.classList.add('active'); pg.querySelectorAll('.enter').forEach(el=>{ el.style.animationName='none'; requestAnimationFrame(()=>{ el.style.animationName=''; }); }) }

  // Update nav items
  document.querySelectorAll('.navItem,[data-page]').forEach(el=>{
    el.classList.toggle('active',el.dataset.page===page);
  });

  // Render if needed
  if(page==='calendar') renderCalendar();
  if(page==='tech') renderTechFull();
  if(page==='guards') renderGuards();
  if(page==='messages') renderMessages();
  if(page==='admin') renderAdmin();
}

// ============================================================
// RENDER: KPIs + SECTOR SUMMARY
// ============================================================
function getDate(){ return $('datePicker')?.value||todayISO() }

function getSectorTechs(sector){
  const r=ST.rosters[sector];
  if(!r) return [];
  return r.names.map(name=>({name,shift:getTechShift(sector,name,getDate())||'D'}));
}

function renderKPIs(){
  const date=getDate();
  const plannerSector=document.querySelector('#sectorFilter .filterChip.active')?.dataset.sector||'all';
  const scopedSectors=plannerSector==='all'?SECTORS:[plannerSector];
  let active=0,free=0,corr=0,prev=0;

  scopedSectors.forEach(sec=>{
    const techs=getSectorTechs(sec);
    techs.forEach(t=>{ if(t.shift!=='D'){active++;free++;} });
  });

  corr=ST.incidents.filter(i=>i.status!=='Cerrada').length;
  prev=ST.tasks.filter(t=>t.type==='Preventivo'&&t.status!=='Cerrado').length;
  const otOpen=ST.ots.filter(o=>o.status!=='Cerrada').length;

  // Subtract techs with tasks
  const assigned=new Set(ST.tasks.filter(t=>t.tech&&t.status!=='Cerrado').map(t=>t.tech));
  const actualFree=Math.max(0,free-assigned.size);

  animNum($('kpiActive'),active);
  animNum($('kpiFree'),actualFree);
  animNum($('kpiCorr'),corr);
  animNum($('kpiPrev'),prev);
  animNum($('kpiOT'),otOpen);

  // Sector cards
  document.querySelectorAll('.sectorCard').forEach(card=>{
    const show=plannerSector==='all'||card.dataset.sector===plannerSector;
    card.style.display=show?'':'none';
  });

  SECTORS.forEach(sec=>{
    const techs=getSectorTechs(sec);
    const onShift=techs.filter(t=>t.shift!=='D');
    const guard=ST.guards[sec]||'‚Äî';
    const corrSec=ST.incidents.filter(i=>i.sector===sec&&i.status!=='Cerrada').length;
    const load=onShift.length>0?Math.round((assigned.size/onShift.length)*100):0;

    const pfx=sec==='Electricidad'?'elec':sec==='Fontaner√≠a'?'font':sec==='Mec√°nicos'?'mec':'cli';
    $(pfx+'Guard').textContent=guard||'‚Äî';
    $(pfx+'Free').textContent=onShift.length;
    $(pfx+'Corr').textContent=corrSec;
    $(pfx+'Load').textContent=Math.min(load,100)+'%';
  });
}

// ============================================================
// RENDER: TECH GRID
// ============================================================
function renderTechGrid(){
  const grid=$('techGrid');
  if(!grid) return;
  const plannerSector=document.querySelector('#sectorFilter .filterChip.active')?.dataset.sector||'all';
  const dropdownSector=$('techSectorFilter')?.value||'all';
  const sector=plannerSector!=='all'?plannerSector:dropdownSector;
  const date=getDate();
  const sectors=sector==='all'?SECTORS:[sector];

  const entries=sectors.flatMap(sec=>getRosterEntriesBySector(sec,date));
  const html=entries.map(({name,sec,shift})=>{
      const phone=ST.phones[sec]?.[name]||'';
      const guard=ST.guards[sec]===name;
      const tasks=ST.tasks.filter(t=>t.tech===name&&t.status!=='Cerrado');
      const load=Math.min(tasks.length*25,100);

      const badgesHtml=`
        <span class="badge ${shift}">${SHIFT_LABELS[shift]||shift}</span>
        ${guard?'<span class="badge guard">üõ° Guardia</span>':''}
        ${phone?'<span class="badge phone">üìû</span>':''}
      `;

      const tasksHtml=tasks.slice(0,2).map(t=>
        `<div style="font-size:11px;color:var(--muted);padding:3px 0;border-top:1px solid var(--line)">
          ${t.type==='Correctivo'?'üî¥':t.type==='Preventivo'?'üü°':'üîµ'} ${t.title}
        </div>`).join('');

      return `<div class="techCard shift-${shift} ${guard?'guard':''}" data-tech="${name}" data-sec="${sec}" onclick="showTechDetail('${name}','${sec}')">
        <div class="techHead">
          <div>
            <div class="techName">${name}</div>
            <div class="techSub">${sec}</div>
          </div>
          <div class="badgeRow">${badgesHtml}</div>
        </div>
        <div class="loadBar"><div class="loadFill" style="width:${load}%"></div></div>
        <div class="loadLabel"><span>${tasks.length} tarea${tasks.length!==1?'s':''}</span><span>${load}% carga</span></div>
        ${phone?`<div style="margin-top:6px"><a href="tel:${phone}" class="guardPhone" style="font-size:12px">üìû ${phone}</a></div>`:''}
        ${tasksHtml}
      </div>`;
  }).join('');

  grid.innerHTML=html||'<div class="empty">Sin t√©cnicos en turno</div>';
  bindPlannerDragAndDrop();
}

function renderTechFull(){
  const grid=$('techGridFull');
  if(!grid) return;
  const date=getDate();
  const activeSector=document.querySelector('#techFilter .filterChip.active')?.dataset.sector||'all';
  const sectors=activeSector==='all'?SECTORS:[activeSector];

  const entries=sectors.flatMap(sec=>getRosterEntriesBySector(sec,date));
  const html=entries.map(({name,sec,shift})=>{
      const phone=ST.phones[sec]?.[name]||'';
      const guard=ST.guards[sec]===name;
      const tasks=ST.tasks.filter(t=>t.tech===name&&t.status!=='Cerrado');
      const load=Math.min(tasks.length*25,100);

      return `<div class="techCard shift-${shift} ${guard?'guard':''}" onclick="showTechDetail('${name}','${sec}')">
        <div class="techHead">
          <div>
            <div class="techName">${name}</div>
            <div class="techSub">${sec} ¬∑ <span class="badge ${shift}" style="font-size:10px">${SHIFT_LABELS[shift]}</span></div>
          </div>
          <div class="badgeRow">
            ${guard?'<span class="badge guard">üõ° Guardia</span>':''}
            ${phone?'<span class="badge phone">üìû</span>':''}
          </div>
        </div>
        <div class="loadBar"><div class="loadFill" style="width:${load}%"></div></div>
        <div class="loadLabel"><span>${tasks.length} tareas</span><span>${load}%</span></div>
        ${phone?`<div style="margin-top:6px"><a href="tel:${phone}" style="font-size:12px;color:var(--blue)">üìû ${phone}</a></div>`:''}
      </div>`;
  }).join('');

  grid.innerHTML=html||'<div class="empty">Sin t√©cnicos cargados</div>';
}

function showTechDetail(name, sec){
  const shift=getTechShift(sec,name,getDate())||'D';
  const phone=ST.phones[sec]?.[name]||'Sin tel√©fono';
  const tasks=ST.tasks.filter(t=>t.tech===name);
  const guard=ST.guards[sec]===name;

  $('detailTitle').textContent=`üë∑ ${name}`;
  $('detailBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="formGroup"><div class="label">Sector</div><div style="font-weight:800">${sec}</div></div>
      <div class="formGroup"><div class="label">Turno hoy</div><div class="badge ${shift}" style="display:inline-block">${SHIFT_LABELS[shift]}</div></div>
      <div class="formGroup"><div class="label">Tel√©fono</div><div><a href="tel:${phone}" style="color:var(--blue);font-weight:800">${phone}</a></div></div>
      <div class="formGroup"><div class="label">Guardia</div><div style="color:${guard?'var(--orange)':'var(--dim)'};font-weight:800">${guard?'‚úÖ S√≠':'‚Äî'}</div></div>
    </div>
    <div style="margin-top:12px;font-size:12px;font-weight:800;color:var(--muted)">TAREAS ASIGNADAS (${tasks.length})</div>
    ${tasks.length?tasks.map(t=>`<div class="kanCard" style="margin-top:6px">
      <div class="kct">${t.type==='Correctivo'?'üî¥':t.type==='Preventivo'?'üü°':'üîµ'} ${t.title}</div>
      <div class="kcd">${t.status} ¬∑ ${t.note||'Sin nota'}</div>
    </div>`).join(''):'<div class="muted" style="margin-top:8px">Sin tareas asignadas</div>'}
    <div class="btnRow" style="margin-top:14px">
      ${phone!=='Sin tel√©fono'?`<a href="tel:${phone}" class="btn primary">üìû Llamar</a>`:''}
      <button class="btn" onclick="openModal('modalTask');closeModal('modalDetail')">+ Asignar tarea</button>
    </div>
  `;
  openModal('modalDetail');
}

// ============================================================
// RENDER: TASK TRAY
// ============================================================
function renderTray(){
  const corrEl=$('trayCorr'),prevEl=$('trayPrev'),otEl=$('trayOT');
  const plannerSector=document.querySelector('#sectorFilter .filterChip.active')?.dataset.sector||'all';
  if(!corrEl) return;

  const inScope=t=>plannerSector==='all'||t.sector===plannerSector;
  const corr=ST.tasks.filter(t=>t.type==='Correctivo'&&t.status!=='Cerrado'&&inScope(t));
  const prev=ST.tasks.filter(t=>t.type==='Preventivo'&&t.status!=='Cerrado'&&inScope(t));
  const ot=ST.tasks.filter(t=>t.type==='OT'&&t.status!=='Cerrado'&&inScope(t));

  corrEl.innerHTML=corr.length?corr.map(t=>taskCard(t,'corr')).join(''):'<div class="empty" style="padding:12px;font-size:11px">Sin correctivos</div>';
  prevEl.innerHTML=prev.length?prev.map(t=>taskCard(t,'prev')).join(''):'<div class="empty" style="padding:12px;font-size:11px">Sin preventivos</div>';
  otEl.innerHTML=ot.length?ot.map(t=>taskCard(t,'ot')).join(''):'<div class="empty" style="padding:12px;font-size:11px">Sin OTs en bandeja</div>';
}

function taskCard(t,cls){
  return `<div class="taskCard ${cls}" draggable="true" data-task-id="${t.id}" onclick="showTaskDetail('${t.id}')">
    <div class="tt">${t.title}</div>
    <div class="td">${t.tech||'Sin asignar'} ¬∑ ${t.sector}</div>
  </div>`;
}

function showTaskDetail(id){
  const t=ST.tasks.find(x=>x.id===id);
  if(!t) return;
  $('detailTitle').textContent='üìã Tarea';
  $('detailBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="formGroup"><div class="label">Tipo</div><div style="font-weight:800">${t.type}</div></div>
      <div class="formGroup"><div class="label">Sector</div><div style="font-weight:800">${t.sector}</div></div>
      <div class="formGroup"><div class="label">T√©cnico</div><div style="font-weight:800">${t.tech||'Sin asignar'}</div></div>
      <div class="formGroup"><div class="label">Estado</div>
        <select class="select" onchange="updateTaskStatus('${t.id}',this.value)" style="padding:6px 8px;font-size:12px">
          <option ${t.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${t.status==='En curso'?'selected':''}>En curso</option>
          <option ${t.status==='Cerrado'?'selected':''}>Cerrado</option>
        </select>
      </div>
    </div>
    <div class="formGroup" style="margin-top:10px">
      <div class="label">Descripci√≥n</div>
      <div style="font-weight:800;font-size:14px">${t.title}</div>
    </div>
    ${t.note?`<div class="muted" style="margin-top:6px">${t.note}</div>`:''}
    <div class="btnRow" style="margin-top:14px">
      <button class="btn danger" onclick="deleteTask('${t.id}')">üóë Eliminar</button>
      <button class="btn" data-close="modalDetail">Cerrar</button>
    </div>
  `;
  openModal('modalDetail');
}

function updateTaskStatus(id,status){
  const t=ST.tasks.find(x=>x.id===id);
  if(t){ t.status=status; saveAll(); renderAll(); toast('‚úÖ Estado actualizado'); }
}

function deleteTask(id){
  if(!confirm('¬øEliminar tarea?')) return;
  ST.tasks=ST.tasks.filter(x=>x.id!==id);
  saveAll(); renderAll(); closeModal('modalDetail'); toast('üóë Tarea eliminada');
}

// ============================================================
// RENDER: INCIDENTS
// ============================================================
function renderIncidents(){
  const statuses=['Pendiente','En curso','Cerrada'];
  statuses.forEach(st=>{
    const key=st.replace(' ','');
    const col=$('inc'+key.charAt(0).toUpperCase()+key.slice(1))||$('inc'+key);
    // find by id pattern
  });

  const pend=$('incPend'),curso=$('incCurso'),cerr=$('incCerrada');
  if(!pend) return;

  const byStatus=(s)=>ST.incidents.filter(i=>i.status===s);

  pend.innerHTML=byStatus('Pendiente').map(i=>incCard(i)).join('')||'<div class="empty">Sin incidencias</div>';
  curso.innerHTML=byStatus('En curso').map(i=>incCard(i)).join('')||'<div class="empty">Sin incidencias</div>';
  cerr.innerHTML=byStatus('Cerrada').map(i=>incCard(i)).join('')||'<div class="empty">Sin incidencias</div>';

  $('cntIncPend').textContent=byStatus('Pendiente').length;
  $('cntIncCurso').textContent=byStatus('En curso').length;
  $('cntIncCerrada').textContent=byStatus('Cerrada').length;
}

function incCard(i){
  const sevColor={alta:'var(--red)',media:'var(--yellow)',baja:'var(--green)'}[i.severity]||'var(--muted)';
  return `<div class="kanCard priority-${i.severity}" onclick="showIncDetail('${i.id}')">
    <div class="kct">${i.title}</div>
    <div class="kcd">${i.sector} ¬∑ ${i.location||'‚Äî'}</div>
    <div class="kcm">
      <span class="badge" style="color:${sevColor};border-color:${sevColor}40">${i.severity}</span>
      ${i.tech?`<span class="badge">${i.tech}</span>`:''}
    </div>
  </div>`;
}

function showIncDetail(id){
  const i=ST.incidents.find(x=>x.id===id);
  if(!i) return;
  $('detailTitle').textContent='üö® Incidencia';
  $('detailBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="formGroup"><div class="label">Sector</div><div style="font-weight:800">${i.sector}</div></div>
      <div class="formGroup"><div class="label">Severidad</div><div class="sev-${i.severity}" style="font-weight:800">${i.severity}</div></div>
      <div class="formGroup"><div class="label">Ubicaci√≥n</div><div style="font-weight:800">${i.location||'‚Äî'}</div></div>
      <div class="formGroup"><div class="label">T√©cnico</div><div style="font-weight:800">${i.tech||'Sin asignar'}</div></div>
      <div class="formGroup" style="grid-column:span 2">
        <div class="label">Estado</div>
        <select class="select" onchange="updateIncStatus('${i.id}',this.value)">
          <option ${i.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${i.status==='En curso'?'selected':''}>En curso</option>
          <option ${i.status==='Cerrada'?'selected':''}>Cerrada</option>
        </select>
      </div>
    </div>
    <div class="formGroup" style="margin-top:10px">
      <div class="label">Descripci√≥n</div>
      <div style="font-weight:800">${i.title}</div>
    </div>
    ${i.note?`<div class="muted" style="margin-top:6px">${i.note}</div>`:''}
    <div class="btnRow" style="margin-top:14px">
      <button class="btn danger" onclick="deleteInc('${i.id}')">üóë Eliminar</button>
      <button class="btn" data-close="modalDetail">Cerrar</button>
    </div>
  `;
  openModal('modalDetail');
}

function updateIncStatus(id,status){
  const i=ST.incidents.find(x=>x.id===id);
  if(i){ i.status=status; saveAll(); renderIncidents(); toast('‚úÖ Estado actualizado'); }
}

function deleteInc(id){
  if(!confirm('¬øEliminar incidencia?')) return;
  ST.incidents=ST.incidents.filter(x=>x.id!==id);
  saveAll(); renderIncidents(); closeModal('modalDetail'); toast('üóë Eliminada');
}

// ============================================================
// RENDER: OTs
// ============================================================
function renderOTs(){
  const pend=$('otPend'),curso=$('otCurso'),cerr=$('otCerrada');
  if(!pend) return;

  const byStatus=(s)=>ST.ots.filter(o=>o.status===s);

  pend.innerHTML=byStatus('Pendiente').map(o=>otCard(o)).join('')||'<div class="empty">Sin OTs</div>';
  curso.innerHTML=byStatus('En curso').map(o=>otCard(o)).join('')||'<div class="empty">Sin OTs</div>';
  cerr.innerHTML=byStatus('Cerrada').map(o=>otCard(o)).join('')||'<div class="empty">Sin OTs</div>';

  $('cntOTPend').textContent=byStatus('Pendiente').length;
  $('cntOTCurso').textContent=byStatus('En curso').length;
  $('cntOTCerrada').textContent=byStatus('Cerrada').length;
}

function otCard(o){
  return `<div class="kanCard priority-${o.priority}" onclick="showOTDetail('${o.id}')">
    <div class="kct">${o.num?'['+o.num+'] ':''}${o.title}</div>
    <div class="kcd">${o.sector} ¬∑ ${o.tech||'Sin asignar'}</div>
    <div class="kcm">
      <span class="badge">${o.priority}</span>
    </div>
  </div>`;
}

function showOTDetail(id){
  const o=ST.ots.find(x=>x.id===id);
  if(!o) return;
  $('detailTitle').textContent='üõ†Ô∏è Orden de Trabajo';
  $('detailBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="formGroup"><div class="label">N√∫mero OT</div><div style="font-weight:800">${o.num||'‚Äî'}</div></div>
      <div class="formGroup"><div class="label">Sector</div><div style="font-weight:800">${o.sector}</div></div>
      <div class="formGroup"><div class="label">T√©cnico</div><div style="font-weight:800">${o.tech||'Sin asignar'}</div></div>
      <div class="formGroup">
        <div class="label">Estado</div>
        <select class="select" onchange="updateOTStatus('${o.id}',this.value)">
          <option ${o.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${o.status==='En curso'?'selected':''}>En curso</option>
          <option ${o.status==='Cerrada'?'selected':''}>Cerrada</option>
        </select>
      </div>
    </div>
    <div class="formGroup" style="margin-top:10px">
      <div class="label">Descripci√≥n</div>
      <div style="font-weight:800">${o.title}</div>
    </div>
    ${o.note?`<div class="muted" style="margin-top:6px">${o.note}</div>`:''}
    <div class="btnRow" style="margin-top:14px">
      <button class="btn danger" onclick="deleteOT('${o.id}')">üóë Eliminar</button>
      <button class="btn" data-close="modalDetail">Cerrar</button>
    </div>
  `;
  openModal('modalDetail');
}

function updateOTStatus(id,status){
  const o=ST.ots.find(x=>x.id===id);
  if(o){ o.status=status; saveAll(); renderOTs(); toast('‚úÖ Estado OT actualizado'); }
}

function deleteOT(id){
  if(!confirm('¬øEliminar OT?')) return;
  ST.ots=ST.ots.filter(x=>x.id!==id);
  saveAll(); renderOTs(); closeModal('modalDetail'); toast('üóë OT eliminada');
}

// ============================================================
// RENDER: CALENDAR
// ============================================================
let calWeekOffset=0;

function renderCalendar(){
  const isCoord=currentUser?.role==='coord';
  const sector=isCoord
    ? ($('calSector')?.value||'Electricidad')
    : (SECTORS.find(sec=>ST.rosters[sec]?.names?.includes(currentUser?.name))||'Electricidad');
  if(!isCoord && $('calSector')) $('calSector').value=sector;
  const baseDate=getDate();
  const d=new Date(baseDate+'T00:00:00');
  d.setDate(d.getDate()+calWeekOffset*7);
  const weekISO=d.toISOString().slice(0,10);
  const week=getWeekDays(weekISO);

  // Week label
  const fmt=dt=>new Date(dt+'T00:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'short'});
  $('weekLabel').textContent=`${fmt(week[0])} ‚Äì ${fmt(week[6])}`;

  const r=ST.rosters[sector];
  const calTable=$('calTable');
  if(!calTable) return;

  if(!r || !r.names.length){
    calTable.innerHTML='<div class="empty">Importa un Excel para este sector</div>';
    renderMonthGrid(sector);
    return;
  }

  const canEdit=isCoord;
  const today=todayISO();
  const dayNames=['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];

  let html=`<div class="calHeader">
    <div class="calTechHead">T√©cnico</div>
    ${week.map((d,i)=>`<div class="calHeadCell ${d===today?'todayCol':''}">${dayNames[i]}<br><small>${d.slice(8)}</small></div>`).join('')}
  </div>`;

  const namesToRender=isCoord?r.names:r.names.filter(name=>name===currentUser?.name);
  namesToRender.forEach(name=>{
    const row=week.map(d=>{
      const shift=getTechShift(sector,name,d)||'D';
      const title=canEdit?'Click para cambiar turno':(SHIFT_LABELS[shift]||shift);
      const extra=canEdit?` data-tech="${name}" data-day="${d}" data-sector="${sector}"`:' aria-readonly="true"';
      return `<div class="calCell ${shift} ${d===today?'todayCol':''} ${canEdit?'editable':'readonly'}" title="${title}"${extra}>${SHIFT_LABELS[shift]||shift}</div>`;
    }).join('');
    html+=`<div class="calRow"><div class="calTech">${name}</div>${row}</div>`;
  });

  if(!namesToRender.length){
    html+=`<div class="calRow"><div class="calTech">${currentUser?.name||'‚Äî'}</div>${week.map(()=>'<div class="calCell D">‚Äî</div>').join('')}</div>`;
  }

  calTable.innerHTML=html;
  if(canEdit) bindCalendarEdition();
  renderMonthGrid(sector);
}

function renderMonthGrid(sector){
  const grid=$('monthGrid');
  if(!grid) return;

  const date=getDate();
  const {y,m}=isoToYMD(date);
  const monthTitle=$('monthTitle');
  if(monthTitle){
    const label=new Date(`${y}-${String(m).padStart(2,'0')}-01T00:00:00`).toLocaleDateString('es-ES',{month:'long',year:'numeric'});
    monthTitle.textContent=`üìÖ ${label}`;
  }
  const monthUpdated=$('monthUpdated');
  if(monthUpdated){
    const today=todayISO();
    const now=new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
    monthUpdated.textContent=`Actualizado ¬∑ ${today} ${now}`;
  }

  const daysInMonth=new Date(y,m,0).getDate();
  const firstDay=new Date(y,m-1,1).getDay()||7;

  let html='';
  for(let i=1;i<firstDay;i++) html+='<div></div>';

  const isCoord=currentUser?.role==='coord';
  const techName=currentUser?.name;
  const today=todayISO();
  const rosterAvailable=isCoord
    ? Object.values(ST.rosters).some(rr=>rr?.names?.length)
    : !!ST.rosters[sector];
  if(!rosterAvailable){grid.innerHTML='<div class="empty" style="grid-column:span 7">Sin datos</div>';return;}

  for(let d=1;d<=daysInMonth;d++){
    const iso=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(isCoord){
      const counts={M:0,T:0,N:0,D:0};
      Object.entries(ST.rosters).forEach(([sec,rr])=>{
        (rr?.names||[]).forEach(name=>{
          const sh=getTechShift(sec,name,iso)||'D';
          const k=sh.split('/')[0];
          if(counts[k]!==undefined) counts[k]++;
        });
      });
      const dominant=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
      html+=`<div class="monthDay ${dominant} ${iso===today?'today':''}" data-day="${iso}" title="${iso}">
        <div class="dayNum">${d}</div>
        <small>${counts.M}${SHIFT_SHORT.M} ${counts.T}${SHIFT_SHORT.T} ${counts.N}${SHIFT_SHORT.N}</small>
      </div>`;
    } else {
      const r=ST.rosters[sector];
      const shift=(techName&&r?.names?.includes(techName)?(getTechShift(sector,techName,iso)||'D'):'D').split('/')[0];
      html+=`<div class="monthDay ${shift} ${iso===today?'today':''}" data-day="${iso}" title="${iso}">
        <div class="dayNum">${d}</div>
        <small>${SHIFT_LABELS[shift]||'‚Äî'}</small>
      </div>`;
    }
  }

  grid.innerHTML=html;
  bindMonthNotes();
}

function bindMonthNotes(){
  const noteInput=$('dayNoteText');
  const hint=$('dayNoteHint');
  if(!noteInput||!hint) return;
  const defaultDay=getDate();
  if(!selectedNoteDay) selectedNoteDay=defaultDay;
  const updateUI=()=>{
    const note=ST.dayNotes[selectedNoteDay]||'';
    noteInput.value=note;
    hint.textContent=`Nota para ${selectedNoteDay}`;
    document.querySelectorAll('#monthGrid .monthDay').forEach(x=>{
      x.classList.toggle('noteSelected',x.dataset.day===selectedNoteDay);
    });
  };
  document.querySelectorAll('#monthGrid .monthDay[data-day]').forEach(el=>{
    el.addEventListener('click',()=>{
      selectedNoteDay=el.dataset.day;
      document.querySelectorAll('#monthGrid .monthDay').forEach(x=>x.classList.remove('noteSelected'));
      el.classList.add('noteSelected');
      updateUI();
    });
  });
  updateUI();
}

// ============================================================
// RENDER: GUARDS
// ============================================================
function renderGuards(){
  const panel=$('guardPanel');
  if(!panel) return;

  const sectors=SECTORS;
  let html='';

  sectors.forEach(sec=>{
    const guard=ST.guards[sec];
    const phone=guard?ST.phones[sec]?.[guard]||'Sin tel.':'';
    const shift=guard?getTechShift(sec,guard,getDate())||'D':'';

    html+=`<div class="guardCard ${guard?'active-guard':''}">
      <div class="guardSector">${sec}</div>
      <div class="guardName">${guard||'Sin guardia asignada'}</div>
      ${guard?`<div class="guardPhone">
        <span style="color:var(--dim);font-size:11px">üìû</span>
        <a href="tel:${phone}">${phone}</a>
      </div>
      <div style="margin-top:6px"><span class="badge ${shift}">${SHIFT_LABELS[shift]||'‚Äî'}</span></div>`:''}
    </div>`;
  });

  // Also show all phones
  const dir=$('phonesDir');
  if(dir){
    let phonesHtml='';
    sectors.forEach(sec=>{
      const phones=ST.phones[sec]||{};
      Object.entries(phones).forEach(([name,ph])=>{
        if(!ph) return;
        const shift=getTechShift(sec,name,getDate())||'D';
        phonesHtml+=`<div class="techCard shift-${shift}" style="padding:10px 12px">
          <div class="techName" style="font-size:13px">${name}</div>
          <div class="techSub">${sec}</div>
          <div style="margin-top:6px"><a href="tel:${ph}" style="color:var(--blue);font-weight:800;font-size:13px">üìû ${ph}</a></div>
        </div>`;
      });
    });
    dir.innerHTML=phonesHtml||'<div class="empty">Sin tel√©fonos registrados</div>';
  }

  panel.innerHTML=html;
  renderCentralGuardPhones();
}

function renderCentralGuardPhones(){
  const wrap=$('centralGuardPhones');
  if(!wrap) return;
  let html='';
  SECTORS.forEach(sec=>{
    const shifts=ST.guardPhonesByShift[sec]||{};
    const parts=['M','T','N'].map(sh=>{
      const name=shifts[sh]||'‚Äî';
      const phone=(name!=='‚Äî'&&ST.phones[sec]?.[name])?ST.phones[sec][name]:'Sin tel√©fono';
      return `<div class="guardPhoneItem"><b>${sec} ¬∑ ${SHIFT_LABELS[sh]}</b><span>${name} ¬∑ ${phone}</span></div>`;
    }).join('');
    html+=parts;
  });
  wrap.innerHTML=html||'<div class="empty" style="padding:10px">Sin tel√©fonos de guardia asignados</div>';
}

// ============================================================
// RENDER: MESSAGES
// ============================================================
function renderMessages(){
  const list=$('msgList');
  if(!list) return;
  if(!ST.messages.length){list.innerHTML='<div class="empty">Sin mensajes</div>';return;}
  list.innerHTML=[...ST.messages].reverse().map(m=>`
    <div class="msgItem">
      <div class="msgHead">
        <div class="msgAvatar">${m.author.charAt(0).toUpperCase()}</div>
        <div>
          <div class="msgAuthor">${m.author}</div>
          <div class="muted" style="font-size:10px">${m.sector==='all'?'Todos':m.sector}</div>
        </div>
        <div class="msgTime">${new Date(m.ts).toLocaleString('es-ES',{hour:'2-digit',minute:'2-digit',day:'numeric',month:'short'})}</div>
        <span class="msgTag">${m.type}</span>
      </div>
      <div class="msgText">${m.text}</div>
    </div>
  `).join('');
}

// ============================================================
// RENDER: ADMIN
// ============================================================
function renderAdmin(){
  // Populate users list
  const ul=$('usersList');
  if(!ul) return;
  const r=ST.rosters;
  const allNames=new Set();
  Object.values(r).forEach(roster=>roster.names?.forEach(n=>allNames.add(n)));

  if(!allNames.size){ul.innerHTML='<div class="empty">Importa un Excel para ver usuarios</div>';return;}

  const bySector=new Map();
  SECTORS.forEach(sec=>{
    (ST.rosters[sec]?.names||[]).forEach(name=>bySector.set(name,sec));
  });

  const category=$('userCategoryFilter')?.value||'all';
  const nameQuery=($('userNameFilter')?.value||'').trim().toLowerCase();

  const filtered=[...allNames].filter(name=>{
    const matchesCategory=category==='all'||bySector.get(name)===category;
    const matchesName=!nameQuery||name.toLowerCase().includes(nameQuery);
    return matchesCategory&&matchesName;
  });

  if(!filtered.length){
    ul.innerHTML='<div class="empty">No hay t√©cnicos para ese filtro</div>';
    return;
  }

  ul.innerHTML=filtered.map(name=>{
    const pass=ST.users.tecnicos?.[name]||'1234';
    const sector=bySector.get(name)||'Sin categor√≠a';
    return `<div class="techCard" style="padding:12px">
      <div class="techName" style="font-size:13px;margin-bottom:8px">${name}</div>
      <div class="techSub" style="margin-bottom:8px">${sector}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="input" type="password" value="${pass}" id="pass_${name.replace(/\s/g,'_')}" style="flex:1;padding:7px 10px;font-size:12px" placeholder="Contrase√±a" />
        <button class="btn sm primary" onclick="saveTechPass('${name}')">Guardar</button>
      </div>
    </div>`;
  }).join('');
}

function saveTechPass(name){
  const el=$('pass_'+name.replace(/\s/g,'_'));
  if(!el) return;
  if(!ST.users.tecnicos) ST.users.tecnicos={};
  ST.users.tecnicos[name]=el.value;
  saveAll();
  toast(`‚úÖ Contrase√±a guardada para ${name}`);
}

// ============================================================
// POPULATE SELECTS with tech names
// ============================================================
function populateTechSelects(){
  const date=getDate();
  const allTechs=SECTORS.flatMap(sec=>getRosterEntriesBySector(sec,date));

  function fillTechSelect(selectId, sectorValue){
    const el=$(selectId);
    if(!el) return;
    const prev=el.value;
    const scoped=sectorValue?allTechs.filter(t=>t.sec===sectorValue):allTechs;
    el.innerHTML='<option value="">Sin asignar</option>'+scoped.map(t=>`<option value="${t.name}">${formatTechOption(t)}</option>`).join('');
    if(prev && scoped.some(t=>t.name===prev)) el.value=prev;
  }

  fillTechSelect('taskTech',$('taskSector')?.value);
  fillTechSelect('incTech',$('incSector')?.value);
  fillTechSelect('otTech',$('otSector')?.value);

  ['guardElec','guardFont','guardMec','guardCli'].forEach(id=>{
    const el=$(id);
    if(!el) return;
    const sector=id==='guardElec'?'Electricidad':id==='guardFont'?'Fontaner√≠a':id==='guardMec'?'Mec√°nicos':'Climatizaci√≥n';
    const options=allTechs
      .filter(t=>t.sec===sector)
      .map(t=>`<option value="${t.name}">${t.name}</option>`)
      .join('');
    el.innerHTML='<option value="">‚Äî Sin guardia ‚Äî</option>'+options;
    el.value=ST.guards[sector]||'';
  });

  renderGuardPhoneShiftForm();
}

function renderGuardPhoneShiftForm(){
  const box=$('guardPhoneShiftForm');
  if(!box) return;
  const date=getDate();
  let html='';
  SECTORS.forEach(sec=>{
    const roster=ST.rosters[sec];
    const names=roster?.names||[];
    const byShift={M:[],T:[],N:[]};
    names.forEach(name=>{
      const sh=getTechShift(sec,name,date)||'D';
      if(byShift[sh]) byShift[sh].push(name);
    });
    html+=`<div class="formGroup">
      <label class="label">Tel√©fono de guardia ¬∑ ${sec}</label>
      <div class="phoneShiftGrid">
        ${['M','T','N'].map(sh=>{
          const options=(byShift[sh]||[]).map(n=>`<option value="${n}">${n}</option>`).join('');
          return `<div><div class="noteHint">${SHIFT_LABELS[sh]}</div><select class="select" data-sec="${sec}" data-sh="${sh}"><option value="">‚Äî Sin t√©cnico ‚Äî</option>${options}</select></div>`;
        }).join('')}
      </div>
    </div>`;
  });
  box.innerHTML=html;
  box.querySelectorAll('select[data-sec][data-sh]').forEach(sel=>{
    const sec=sel.dataset.sec, sh=sel.dataset.sh;
    sel.value=ST.guardPhonesByShift[sec]?.[sh]||'';
    sel.addEventListener('change',()=>{
      if(!ST.guardPhonesByShift[sec]) ST.guardPhonesByShift[sec]={M:'',T:'',N:''};
      ST.guardPhonesByShift[sec][sh]=sel.value;
    });
  });
}

function bindPlannerDragAndDrop(){
  const cards=document.querySelectorAll('#trayCorr .taskCard, #trayPrev .taskCard, #trayOT .taskCard');
  cards.forEach(card=>{
    card.addEventListener('dragstart',()=>card.classList.add('dragging'));
    card.addEventListener('dragend',()=>card.classList.remove('dragging'));
  });

  document.querySelectorAll('#techGrid .techCard').forEach(card=>{
    card.addEventListener('dragover',e=>{
      e.preventDefault();
      card.style.boxShadow='0 0 0 2px rgba(58,159,255,.45) inset, 0 0 18px rgba(58,159,255,.25)';
    });
    card.addEventListener('dragleave',()=>{ card.style.boxShadow=''; });
    card.addEventListener('drop',()=>{
      card.style.boxShadow='';
      const dragging=document.querySelector('.taskCard.dragging');
      if(!dragging) return;
      const taskId=dragging.dataset.taskId;
      const tech=card.dataset.tech;
      const sec=card.dataset.sec;
      const task=ST.tasks.find(t=>t.id===taskId);
      if(!task||!tech) return;
      task.tech=tech;
      task.sector=sec||task.sector;
      saveAll();
      renderAll();
      toast(`‚úÖ ${task.title} asignada a ${tech}`);
    });
  });
}

// ============================================================
// MODAL SYSTEM
// ============================================================
function openModal(id){
  const bd=$('backdrop');
  bd.classList.add('open');
  const m=$(id);
  if(m) m.classList.add('open');
}
function closeModal(id){
  const m=$(id);
  if(m) m.classList.remove('open');
  // Close backdrop if no other modal open
  if(!document.querySelector('.modal.open')) $('backdrop').classList.remove('open');
}

// Close on backdrop click
$('backdrop').addEventListener('click',()=>{
  document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
  $('backdrop').classList.remove('open');
});

// Close buttons
document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.addEventListener('click',()=>closeModal(btn.dataset.close));
});

// ============================================================
// RENDER ALL
// ============================================================
function renderAll(){
  renderKPIs();
  renderTray();
  renderTechGrid();
  renderIncidents();
  renderOTs();
  populateTechSelects();
  renderCentralGuardPhones();
  if(activePage==='calendar') renderCalendar();
  if(activePage==='tech') renderTechFull();
  if(activePage==='guards') renderGuards();
  if(activePage==='messages') renderMessages();
  if(activePage==='admin') renderAdmin();
}

// ============================================================
// CLOCK
// ============================================================
function updateClock(){
  $('clock').textContent=new Date().toLocaleTimeString('es-ES',{hour12:false});
}
setInterval(updateClock,1000);
updateClock();

// ============================================================
// EVENT LISTENERS
// ============================================================

// Navigation
document.querySelectorAll('[data-page]').forEach(btn=>{
  btn.addEventListener('click',()=>goPage(btn.dataset.page));
});

// Date picker
$('datePicker').value=todayISO();
$('datePicker').addEventListener('change',()=>{ renderAll(); if(activePage==='calendar') renderCalendar(); });

// Sector filter (planner)
$('sectorFilter').addEventListener('click',e=>{
  const chip=e.target.closest('[data-sector]');
  if(!chip) return;
  $('sectorFilter').querySelectorAll('.filterChip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  if($('techSectorFilter')) $('techSectorFilter').value=chip.dataset.sector==='all'?'all':chip.dataset.sector;
  renderAll();
});

// Tech filter
document.querySelectorAll('[data-page="tech"] .filterChip, #techFilter .filterChip').forEach(chip=>{
  chip&&chip.addEventListener('click',()=>{
    document.querySelectorAll('#techFilter .filterChip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    renderTechFull();
  });
});
const techFilterEl=$('techFilter');
if(techFilterEl) techFilterEl.addEventListener('click',e=>{
  const chip=e.target.closest('[data-sector]');
  if(!chip) return;
  techFilterEl.querySelectorAll('.filterChip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  renderTechFull();
});

// Tech sector filter dropdown
$('techSectorFilter')?.addEventListener('change',renderTechGrid);

['taskSector','incSector','otSector'].forEach(id=>{
  $(id)?.addEventListener('change',populateTechSelects);
});


// Calendar nav
$('btnSaveDayNote')?.addEventListener('click',()=>{
  const text=($('dayNoteText')?.value||'').trim();
  const day=selectedNoteDay||getDate();
  if(text) ST.dayNotes[day]=text;
  else delete ST.dayNotes[day];
  saveAll();
  const hint=$('dayNoteHint');
  if(hint) hint.textContent=`Nota ${text?'guardada':'eliminada'} para ${day}`;
  toast(text?'üìù Nota guardada':'üßπ Nota eliminada');
});

$('btnWeekPrev').addEventListener('click',()=>{calWeekOffset--;renderCalendar()});
$('btnWeekNext').addEventListener('click',()=>{calWeekOffset++;renderCalendar()});
$('calSector').addEventListener('change',()=>renderCalendar());

// Import roster (calendar page)
$('rosterFile').addEventListener('change',function(){
  const file=this.files[0];
  if(!file) return;
  const sector=$('calSector').value;
  if(file.name.endsWith('.csv')){
    const reader=new FileReader();
    reader.onload=e=>{ ST.rosters[sector]=parseRosterCSV(e.target.result,sector); saveAll(); renderAll(); toast('‚úÖ Cuadrante importado'); };
    reader.readAsText(file);
  } else {
    parseXLSX(file,sector,r=>{ ST.rosters[sector]=r; saveAll(); renderAll(); toast('‚úÖ Cuadrante Excel importado'); });
  }
});

// Export roster
$('btnExportRoster').addEventListener('click',()=>{
  const sector=$('calSector').value;
  const r=ST.rosters[sector];
  if(!r){toast('Sin datos para exportar');return;}
  const rows=[['Nombre',...r.days],...r.names.map((n,i)=>[n,...r.matrix[i]])];

  if(window.XLSX?.utils){
    const ws=XLSX.utils.aoa_to_sheet(rows);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,sector);
    XLSX.writeFile(wb,`Cuadrante_${sector}_${getDate()}.xlsx`);
    toast('‚¨áÔ∏è Excel exportado');
    return;
  }

  const csv=rows.map(row=>row.map(v=>`"${String(v??'').replaceAll('\"','\"\"')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`Cuadrante_${sector}_${getDate()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast('‚¨áÔ∏è Descargado en CSV (modo compatibilidad)');
});

// Import OTs
$('otFile').addEventListener('change',function(){
  const file=this.files[0];
  if(file) parseOTsFromXLSX(file);
});

// Admin master import
$('adminExcelFile').addEventListener('change',function(){
  const file=this.files[0];
  if(file) parseMasterXLSX(file);
});

// Drag over importZone
const iz=$('importZoneAdmin');
if(iz){
  iz.addEventListener('dragover',e=>{e.preventDefault();iz.classList.add('over')});
  iz.addEventListener('dragleave',()=>iz.classList.remove('over'));
  iz.addEventListener('drop',e=>{
    e.preventDefault();iz.classList.remove('over');
    const file=e.dataTransfer.files[0];
    if(file) parseMasterXLSX(file);
  });
}

// New task modal
$('btnNewTask').addEventListener('click',()=>openModal('modalTask'));
$('btnAddTask').addEventListener('click',()=>openModal('modalTask'));

$('btnSaveTask').addEventListener('click',()=>{
  const title=$('taskTitle').value.trim();
  if(!title){toast('‚ö†Ô∏è Escribe una descripci√≥n');return;}
  ST.tasks.push({
    id:uid(),
    type:$('taskType').value,
    sector:$('taskSector').value,
    title,
    tech:$('taskTech').value,
    priority:$('taskPriority').value,
    note:$('taskNote').value,
    status:'Pendiente',
    created:new Date().toISOString(),
  });
  saveAll();renderAll();closeModal('modalTask');
  $('taskTitle').value='';$('taskNote').value='';
  toast('‚úÖ Tarea creada');
});

// New incident
$('btnNewIncident').addEventListener('click',()=>openModal('modalIncident'));
$('btnSaveIncident').addEventListener('click',()=>{
  const title=$('incTitle').value.trim();
  if(!title){toast('‚ö†Ô∏è Describe la incidencia');return;}
  ST.incidents.push({
    id:uid(),
    sector:$('incSector').value,
    severity:$('incSeverity').value,
    title,
    location:$('incLocation').value,
    tech:$('incTech').value,
    note:$('incNote').value,
    status:'Pendiente',
    created:new Date().toISOString(),
  });
  saveAll();renderIncidents();renderKPIs();closeModal('modalIncident');
  $('incTitle').value='';$('incNote').value='';$('incLocation').value='';
  toast('üö® Incidencia registrada');
});

// New OT
$('btnNewOT').addEventListener('click',()=>openModal('modalOT'));
$('btnSaveOT').addEventListener('click',()=>{
  const title=$('otTitle').value.trim();
  if(!title){toast('‚ö†Ô∏è Describe la OT');return;}
  ST.ots.push({
    id:uid(),
    num:$('otNum').value,
    sector:$('otSector').value,
    title,
    tech:$('otTech').value,
    priority:$('otPriority').value,
    note:$('otNote').value,
    status:'Pendiente',
    created:new Date().toISOString(),
  });
  saveAll();renderOTs();renderKPIs();closeModal('modalOT');
  $('otTitle').value='';$('otNote').value='';$('otNum').value='';
  toast('üõ†Ô∏è OT creada');
});

// Messages
$('btnMsg').addEventListener('click',()=>{ goPage('messages'); });
$('btnSendMsg').addEventListener('click',()=>{
  const text=$('msgText').value.trim();
  if(!text){toast('‚ö†Ô∏è Escribe un mensaje');return;}
  ST.messages.push({
    id:uid(),
    text,
    type:$('msgType').value,
    sector:$('msgSector').value,
    author:currentUser?.name||'Coordinador',
    ts:new Date().toISOString(),
  });
  saveAll();renderMessages();
  $('msgText').value='';
  toast('üí¨ Mensaje enviado');
});

// Guards
$('btnEditGuard')?.addEventListener('click',()=>openModal('modalGuard'));
$('btnSaveGuard').addEventListener('click',()=>{
  ST.guards['Electricidad']=$('guardElec').value;
  ST.guards['Fontaner√≠a']=$('guardFont').value;
  ST.guards['Mec√°nicos']=$('guardMec').value;
  ST.guards['Climatizaci√≥n']=$('guardCli').value;
  saveAll();renderKPIs();renderGuards();renderCentralGuardPhones();closeModal('modalGuard');
  toast('‚úÖ Guardias guardadas');
});

// Backup
$('btnExportBackup').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(ST,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`backup_isivolt_${todayISO()}.json`;
  a.click();
  toast('‚¨áÔ∏è Backup exportado');
});

$('backupFile').addEventListener('change',function(){
  const file=this.files[0];
  if(!file) return;
  if(!confirm('¬øRestaurar backup? Sobrescribir√° todos los datos.')) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      Object.assign(ST,data);
      saveAll();renderAll();toast('‚úÖ Backup restaurado');
    }catch{ toast('‚ùå Error en backup'); }
  };
  reader.readAsText(file);
});

$('btnClearAll').addEventListener('click',()=>{
  if(!confirm('¬øBorrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) return;
  Object.keys(LS_KEYS).forEach(k=>localStorage.removeItem(LS_KEYS[k]));
  location.reload();
});

// Coordinator pass
$('btnSaveCoordPass').addEventListener('click',()=>{
  const pass=$('coordPass').value;
  if(!pass){toast('‚ö†Ô∏è Escribe una contrase√±a');return;}
  localStorage.setItem(COORD_PASS_KEY,pass);
  ST.users.coordinador=pass;
  saveAll();toast('‚úÖ Contrase√±a del coordinador guardada');
  $('coordPass').value='';
});

// Search
$('globalSearch').addEventListener('input',function(){
  const q=this.value.toLowerCase().trim();
  if(!q){ renderAll(); return; }
  // Filter tech grid
  document.querySelectorAll('.techCard').forEach(card=>{
    const name=card.querySelector('.techName')?.textContent||'';
    card.style.display=name.toLowerCase().includes(q)?'':'none';
  });
});

// Logout
$('btnLogout').addEventListener('click',doLogout);
$('userPill').addEventListener('click',()=>{
  if(currentUser?.role==='coord') goPage('admin');
});

$('userCategoryFilter')?.addEventListener('change',renderAdmin);
$('userNameFilter')?.addEventListener('input',renderAdmin);

// ============================================================
// LOGIN
// ============================================================
$('tabTech').addEventListener('click',()=>{
  $('tabTech').classList.add('on');$('tabCoord').classList.remove('on');
  $('loginUser').disabled=false;
  populateLoginUsers();
});
$('tabCoord').addEventListener('click',()=>{
  $('tabCoord').classList.add('on');$('tabTech').classList.remove('on');
  $('loginUser').innerHTML='<option value="Coordinador">Coordinador</option>';
  $('loginUser').disabled=true;
});

function populateLoginUsers(){
  const allNames=new Set();
  Object.values(ST.rosters).forEach(r=>r.names?.forEach(n=>allNames.add(n)));
  $('loginUser').innerHTML='<option value="">‚Äî Selecciona tu nombre ‚Äî</option>'+
    [...allNames].map(n=>`<option value="${n}">${n}</option>`).join('');
}

$('btnLogin').addEventListener('click',()=>{
  const isCoord=$('tabCoord').classList.contains('on');
  const role=isCoord?'coord':'tech';
  const name=isCoord?'Coordinador':$('loginUser').value;
  const pass=$('loginPass').value;
  if(!name){$('loginHint').textContent='‚ö†Ô∏è Selecciona un nombre';return;}
  if(!pass){$('loginHint').textContent='‚ö†Ô∏è Escribe tu contrase√±a';return;}
  if(!doLogin(role,name,pass)){
    $('loginHint').textContent='‚ùå Contrase√±a incorrecta (prueba: 1234)';
  }
});
$('loginPass').addEventListener('keydown',e=>{ if(e.key==='Enter') $('btnLogin').click(); });

// ============================================================
// INIT
// ============================================================
function init(){
  if(currentUser){
    $('loginOverlay').classList.add('hidden');
    applyRoleUI();
    renderAll();
  } else {
    // Show login
    $('loginOverlay').classList.remove('hidden');
    populateLoginUsers();
    // Populate with demo data already loaded
    renderAll(); // render behind
  }

  // Default date
  $('datePicker').value=todayISO();

  // Auto-login if no auth system (dev mode - comment out in prod)
  // For demo: show login
}

init();
</script>
</body>
</html>
